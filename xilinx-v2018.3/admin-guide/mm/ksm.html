

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Kernel Samepage Merging &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="NUMA Memory Policy" href="numa_memory_policy.html" />
    <link rel="prev" title="Idle Page Tracking" href="idle_page_tracking.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.19.0-xilinx-v2018.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Linux kernel licensing rules</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux kernel user’s and administrator’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../README.html">Linux kernel release 4.x &lt;http://kernel.org/&gt;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-parameters.html">The kernel’s command-line parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devices.html">Linux allocated devices (4.x+ version)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../l1tf.html">L1TF - L1 Terminal Fault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reporting-bugs.html">Reporting bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security-bugs.html">Security bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bug-hunting.html">Bug hunting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bug-bisect.html">Bisecting a bug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tainted-kernels.html">Tainted kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ramoops.html">Ramoops oops/panic logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamic-debug-howto.html">Dynamic debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../init.html">Explaining the dreaded “No init found.” boot hang message</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysfs-rules.html">Rules on how to access information in sysfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../initrd.html">Using the initial RAM disk (initrd)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cgroup-v2.html">Control Group v2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serial-console.html">Linux Serial Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../braille-console.html">Linux Braille Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parport.html">Parport</a></li>
<li class="toctree-l2"><a class="reference internal" href="../md.html">RAID arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module-signing.html">Kernel module signing facility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysrq.html">Linux Magic System Request Key Hacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../unicode.html">Unicode support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vga-softcursor.html">Software cursor for VGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../binfmt-misc.html">Kernel Support for miscellaneous (your favourite) Binary Formats v1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mono.html">Mono(tm) Binary Kernel Support for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../java.html">Java(tm) Binary Kernel Support for Linux v1.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ras.html">Reliability, Availability and Serviceability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bcache.html">A block layer cache (bcache)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thunderbolt.html">Thunderbolt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LSM/index.html">Linux Security Module Usage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Memory Management</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="concepts.html">Concepts overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="hugetlbpage.html">HugeTLB Pages</a></li>
<li class="toctree-l3"><a class="reference internal" href="idle_page_tracking.html">Idle Page Tracking</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Kernel Samepage Merging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-ksm-with-madvise">Controlling KSM with madvise</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ksm-daemon-sysfs-interface">KSM daemon sysfs interface</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="numa_memory_policy.html">NUMA Memory Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="pagemap.html">Examining Process Page Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="soft-dirty.html">Soft-Dirty PTEs</a></li>
<li class="toctree-l3"><a class="reference internal" href="transhuge.html">Transparent Hugepage Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="userfaultfd.html">Userfaultfd</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Linux Filesystems API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Filesystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">The Linux kernel user’s and administrator’s guide</a> &raquo;</li>
        
          <li><a href="index.html">Memory Management</a> &raquo;</li>
        
      <li>Kernel Samepage Merging</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin-guide/mm/ksm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kernel-samepage-merging">
<span id="admin-guide-ksm"></span><h1>Kernel Samepage Merging<a class="headerlink" href="#kernel-samepage-merging" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>KSM is a memory-saving de-duplication feature, enabled by CONFIG_KSM=y,
added to the Linux kernel in 2.6.32.  See <code class="docutils literal"><span class="pre">mm/ksm.c</span></code> for its implementation,
and <a class="reference external" href="http://lwn.net/Articles/306704/">http://lwn.net/Articles/306704/</a> and <a class="reference external" href="http://lwn.net/Articles/330589/">http://lwn.net/Articles/330589/</a></p>
<p>KSM was originally developed for use with KVM (where it was known as
Kernel Shared Memory), to fit more virtual machines into physical memory,
by sharing the data common between them.  But it can be useful to any
application which generates many instances of the same data.</p>
<p>The KSM daemon ksmd periodically scans those areas of user memory
which have been registered with it, looking for pages of identical
content which can be replaced by a single write-protected page (which
is automatically copied if a process later wants to update its
content). The amount of pages that KSM daemon scans in a single pass
and the time between the passes are configured using <a class="reference internal" href="#ksm-sysfs"><span class="std std-ref">sysfs
intraface</span></a></p>
<p>KSM only merges anonymous (private) pages, never pagecache (file) pages.
KSM’s merged pages were originally locked into kernel memory, but can now
be swapped out just like other user pages (but sharing is broken when they
are swapped back in: ksmd must rediscover their identity and merge again).</p>
</div>
<div class="section" id="controlling-ksm-with-madvise">
<h2>Controlling KSM with madvise<a class="headerlink" href="#controlling-ksm-with-madvise" title="Permalink to this headline">¶</a></h2>
<p>KSM only operates on those areas of address space which an application
has advised to be likely candidates for merging, by using the madvise(2)
system call:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>int madvise(addr, length, MADV_MERGEABLE)
</pre></div>
</div>
<p>The app may call</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>int madvise(addr, length, MADV_UNMERGEABLE)
</pre></div>
</div>
<p>to cancel that advice and restore unshared pages: whereupon KSM
unmerges whatever it merged in that range.  Note: this unmerging call
may suddenly require more memory than is available - possibly failing
with EAGAIN, but more probably arousing the Out-Of-Memory killer.</p>
<p>If KSM is not configured into the running kernel, madvise MADV_MERGEABLE
and MADV_UNMERGEABLE simply fail with EINVAL.  If the running kernel was
built with CONFIG_KSM=y, those calls will normally succeed: even if the
the KSM daemon is not currently running, MADV_MERGEABLE still registers
the range for whenever the KSM daemon is started; even if the range
cannot contain any pages which KSM could actually merge; even if
MADV_UNMERGEABLE is applied to a range which was never MADV_MERGEABLE.</p>
<p>If a region of memory must be split into at least one new MADV_MERGEABLE
or MADV_UNMERGEABLE region, the madvise may return ENOMEM if the process
will exceed <code class="docutils literal"><span class="pre">vm.max_map_count</span></code> (see Documentation/sysctl/vm.txt).</p>
<p>Like other madvise calls, they are intended for use on mapped areas of
the user address space: they will report ENOMEM if the specified range
includes unmapped gaps (though working on the intervening mapped areas),
and might fail with EAGAIN if not enough memory for internal structures.</p>
<p>Applications should be considerate in their use of MADV_MERGEABLE,
restricting its use to areas likely to benefit.  KSM’s scans may use a lot
of processing power: some installations will disable KSM for that reason.</p>
</div>
<div class="section" id="ksm-daemon-sysfs-interface">
<span id="ksm-sysfs"></span><h2>KSM daemon sysfs interface<a class="headerlink" href="#ksm-daemon-sysfs-interface" title="Permalink to this headline">¶</a></h2>
<p>The KSM daemon is controlled by sysfs files in <code class="docutils literal"><span class="pre">/sys/kernel/mm/ksm/</span></code>,
readable by all but writable only by root:</p>
<dl class="docutils">
<dt>pages_to_scan</dt>
<dd><p class="first">how many pages to scan before ksmd goes to sleep
e.g. <code class="docutils literal"><span class="pre">echo</span> <span class="pre">100</span> <span class="pre">&gt;</span> <span class="pre">/sys/kernel/mm/ksm/pages_to_scan</span></code>.</p>
<p class="last">Default: 100 (chosen for demonstration purposes)</p>
</dd>
<dt>sleep_millisecs</dt>
<dd><p class="first">how many milliseconds ksmd should sleep before next scan
e.g. <code class="docutils literal"><span class="pre">echo</span> <span class="pre">20</span> <span class="pre">&gt;</span> <span class="pre">/sys/kernel/mm/ksm/sleep_millisecs</span></code></p>
<p class="last">Default: 20 (chosen for demonstration purposes)</p>
</dd>
<dt>merge_across_nodes</dt>
<dd><p class="first">specifies if pages from different NUMA nodes can be merged.
When set to 0, ksm merges only pages which physically reside
in the memory area of same NUMA node. That brings lower
latency to access of shared pages. Systems with more nodes, at
significant NUMA distances, are likely to benefit from the
lower latency of setting 0. Smaller systems, which need to
minimize memory usage, are likely to benefit from the greater
sharing of setting 1 (default). You may wish to compare how
your system performs under each setting, before deciding on
which to use. <code class="docutils literal"><span class="pre">merge_across_nodes</span></code> setting can be changed only
when there are no ksm shared pages in the system: set run 2 to
unmerge pages first, then to 1 after changing
<code class="docutils literal"><span class="pre">merge_across_nodes</span></code>, to remerge according to the new setting.</p>
<p class="last">Default: 1 (merging across nodes as in earlier releases)</p>
</dd>
<dt>run</dt>
<dd><ul class="first simple">
<li>set to 0 to stop ksmd from running but keep merged pages,</li>
<li>set to 1 to run ksmd e.g. <code class="docutils literal"><span class="pre">echo</span> <span class="pre">1</span> <span class="pre">&gt;</span> <span class="pre">/sys/kernel/mm/ksm/run</span></code>,</li>
<li>set to 2 to stop ksmd and unmerge all pages currently merged, but
leave mergeable areas registered for next run.</li>
</ul>
<p class="last">Default: 0 (must be changed to 1 to activate KSM, except if
CONFIG_SYSFS is disabled)</p>
</dd>
<dt>use_zero_pages</dt>
<dd><p class="first">specifies whether empty pages (i.e. allocated pages that only
contain zeroes) should be treated specially.  When set to 1,
empty pages are merged with the kernel zero page(s) instead of
with each other as it would happen normally. This can improve
the performance on architectures with coloured zero pages,
depending on the workload. Care should be taken when enabling
this setting, as it can potentially degrade the performance of
KSM for some workloads, for example if the checksums of pages
candidate for merging match the checksum of an empty
page. This setting can be changed at any time, it is only
effective for pages merged after the change.</p>
<p class="last">Default: 0 (normal KSM behaviour as in earlier releases)</p>
</dd>
<dt>max_page_sharing</dt>
<dd>Maximum sharing allowed for each KSM page. This enforces a
deduplication limit to avoid high latency for virtual memory
operations that involve traversal of the virtual mappings that
share the KSM page. The minimum value is 2 as a newly created
KSM page will have at least two sharers. The higher this value
the faster KSM will merge the memory and the higher the
deduplication factor will be, but the slower the worst case
virtual mappings traversal could be for any given KSM
page. Slowing down this traversal means there will be higher
latency for certain virtual memory operations happening during
swapping, compaction, NUMA balancing and page migration, in
turn decreasing responsiveness for the caller of those virtual
memory operations. The scheduler latency of other tasks not
involved with the VM operations doing the virtual mappings
traversal is not affected by this parameter as these
traversals are always schedule friendly themselves.</dd>
<dt>stable_node_chains_prune_millisecs</dt>
<dd>specifies how frequently KSM checks the metadata of the pages
that hit the deduplication limit for stale information.
Smaller milllisecs values will free up the KSM metadata with
lower latency, but they will make ksmd use more CPU during the
scan. It’s a noop if not a single KSM page hit the
<code class="docutils literal"><span class="pre">max_page_sharing</span></code> yet.</dd>
</dl>
<p>The effectiveness of KSM and MADV_MERGEABLE is shown in <code class="docutils literal"><span class="pre">/sys/kernel/mm/ksm/</span></code>:</p>
<dl class="docutils">
<dt>pages_shared</dt>
<dd>how many shared pages are being used</dd>
<dt>pages_sharing</dt>
<dd>how many more sites are sharing them i.e. how much saved</dd>
<dt>pages_unshared</dt>
<dd>how many pages unique but repeatedly checked for merging</dd>
<dt>pages_volatile</dt>
<dd>how many pages changing too fast to be placed in a tree</dd>
<dt>full_scans</dt>
<dd>how many times all mergeable areas have been scanned</dd>
<dt>stable_node_chains</dt>
<dd>the number of KSM pages that hit the <code class="docutils literal"><span class="pre">max_page_sharing</span></code> limit</dd>
<dt>stable_node_dups</dt>
<dd>number of duplicated KSM pages</dd>
</dl>
<p>A high ratio of <code class="docutils literal"><span class="pre">pages_sharing</span></code> to <code class="docutils literal"><span class="pre">pages_shared</span></code> indicates good
sharing, but a high ratio of <code class="docutils literal"><span class="pre">pages_unshared</span></code> to <code class="docutils literal"><span class="pre">pages_sharing</span></code>
indicates wasted effort.  <code class="docutils literal"><span class="pre">pages_volatile</span></code> embraces several
different kinds of activity, but a high proportion there would also
indicate poor use of madvise MADV_MERGEABLE.</p>
<p>The maximum possible <code class="docutils literal"><span class="pre">pages_sharing/pages_shared</span></code> ratio is limited by the
<code class="docutils literal"><span class="pre">max_page_sharing</span></code> tunable. To increase the ratio <code class="docutils literal"><span class="pre">max_page_sharing</span></code> must
be increased accordingly.</p>
<p>–
Izik Eidus,
Hugh Dickins, 17 Nov 2009</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="numa_memory_policy.html" class="btn btn-neutral float-right" title="NUMA Memory Policy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="idle_page_tracking.html" class="btn btn-neutral" title="Idle Page Tracking" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>