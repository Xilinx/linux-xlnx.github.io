

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TODO list &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Security Documentation" href="../security/index.html" />
    <link rel="prev" title="drm/bridge/dw-hdmi Synopsys DesignWare HDMI Controller" href="bridge/dw-hdmi.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.14.0-xilinx-v2018.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux GPU Driver Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-internals.html">DRM Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-mm.html">DRM Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-kms.html">Kernel Mode Setting (KMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-kms-helpers.html">Mode Setting Helper Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-uapi.html">Userland interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="i915.html">drm/i915 Intel GFX Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="meson.html">drm/meson AmLogic Meson Video Processing Unit</a></li>
<li class="toctree-l2"><a class="reference internal" href="pl111.html">drm/pl111 ARM PrimeCell PL111 CLCD Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="tegra.html">drm/tegra NVIDIA Tegra GPU and display driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="tinydrm.html">drm/tinydrm Driver library</a></li>
<li class="toctree-l2"><a class="reference internal" href="vc4.html">drm/vc4 Broadcom VC4 Graphics Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="vga-switcheroo.html">VGA Switcheroo</a></li>
<li class="toctree-l2"><a class="reference internal" href="vgaarbiter.html">VGA Arbiter</a></li>
<li class="toctree-l2"><a class="reference internal" href="bridge/dw-hdmi.html">drm/bridge/dw-hdmi Synopsys DesignWare HDMI Controller</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">TODO list</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#subsystem-wide-refactorings">Subsystem-wide refactorings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#de-midlayer-drivers">De-midlayer drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#switch-from-reference-unreference-to-get-put">Switch from reference/unreference to get/put</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-existing-kms-drivers-to-atomic-modesetting">Convert existing KMS drivers to atomic modesetting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-the-clipped-coordination-confusion-around-planes">Clean up the clipped coordination confusion around planes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implement-deferred-fbdev-setup-in-the-helper">Implement deferred fbdev setup in the helper</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-early-atomic-drivers-to-async-commit-helpers">Convert early atomic drivers to async commit helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#better-manual-upload-support-for-atomic">Better manual-upload support for atomic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fallout-from-atomic-kms">Fallout from atomic KMS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-rid-of-dev-struct-mutex-from-gem-drivers">Get rid of dev-&gt;struct_mutex from GEM drivers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#core-refactorings">Core refactorings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#use-new-idr-deletion-interface-to-clean-up-drm-gem-handle-delete">Use new IDR deletion interface to clean up drm_gem_handle_delete()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-the-drm-header-mess">Clean up the DRM header mess</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-missing-kerneldoc-for-exported-functions">Add missing kerneldoc for exported functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hide-legacy-cruft-better">Hide legacy cruft better</a></li>
<li class="toctree-l4"><a class="reference internal" href="#make-panic-handling-work">Make panic handling work</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-the-debugfs-support">Clean up the debugfs support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#better-testing">Better Testing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enable-trinity-for-drm">Enable trinity for DRM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#make-kms-tests-in-i-g-t-generic">Make KMS tests in i-g-t generic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-virtual-kms-driver-for-testing-vkms">Create a virtual KMS driver for testing (vkms)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#driver-specific">Driver Specific</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tinydrm">tinydrm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#outside-drm">Outside DRM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Linux Filesystems API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/ko_KR/index.html">Korean translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/zh_CN/index.html">Chinese translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/ja_JP/index.html">Japanese translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux GPU Driver Developer’s Guide</a> &raquo;</li>
        
      <li>TODO list</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/gpu/todo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="todo-list">
<span id="todo"></span><h1>TODO list<a class="headerlink" href="#todo-list" title="Permalink to this headline">¶</a></h1>
<p>This section contains a list of smaller janitorial tasks in the kernel DRM
graphics subsystem useful as newbie projects. Or for slow rainy days.</p>
<div class="section" id="subsystem-wide-refactorings">
<h2>Subsystem-wide refactorings<a class="headerlink" href="#subsystem-wide-refactorings" title="Permalink to this headline">¶</a></h2>
<div class="section" id="de-midlayer-drivers">
<h3>De-midlayer drivers<a class="headerlink" href="#de-midlayer-drivers" title="Permalink to this headline">¶</a></h3>
<p>With the recent <code class="docutils literal"><span class="pre">drm_bus</span></code> cleanup patches for 3.17 it is no longer required
to have a <code class="docutils literal"><span class="pre">drm_bus</span></code> structure set up. Drivers can directly set up the
<code class="docutils literal"><span class="pre">drm_device</span></code> structure instead of relying on bus methods in <code class="docutils literal"><span class="pre">drm_usb.c</span></code>
and <code class="docutils literal"><span class="pre">drm_pci.c</span></code>. The goal is to get rid of the driver’s <code class="docutils literal"><span class="pre">-&gt;load</span></code> /
<code class="docutils literal"><span class="pre">-&gt;unload</span></code> callbacks and open-code the load/unload sequence properly, using
the new two-stage <code class="docutils literal"><span class="pre">drm_device</span></code> setup/teardown.</p>
<p>Once all existing drivers are converted we can also remove those bus support
files for USB and platform devices.</p>
<p>All you need is a GPU for a non-converted driver (currently almost all of
them, but also all the virtual ones used by KVM, so everyone qualifies).</p>
<p>Contact: Daniel Vetter, Thierry Reding, respective driver maintainers</p>
</div>
<div class="section" id="switch-from-reference-unreference-to-get-put">
<h3>Switch from reference/unreference to get/put<a class="headerlink" href="#switch-from-reference-unreference-to-get-put" title="Permalink to this headline">¶</a></h3>
<p>For some reason DRM core uses <code class="docutils literal"><span class="pre">reference</span></code>/<code class="docutils literal"><span class="pre">unreference</span></code> suffixes for
refcounting functions, but kernel uses <code class="docutils literal"><span class="pre">get</span></code>/<code class="docutils literal"><span class="pre">put</span></code> (e.g.
<code class="docutils literal"><span class="pre">kref_get</span></code>/<code class="docutils literal"><span class="pre">put()</span></code>). It would be good to switch over for consistency, and
it’s shorter. Needs to be done in 3 steps for each pair of functions:</p>
<ul class="simple">
<li>Create new <code class="docutils literal"><span class="pre">get</span></code>/<code class="docutils literal"><span class="pre">put</span></code> functions, define the old names as compatibility
wrappers</li>
<li>Switch over each file/driver using a cocci-generated spatch.</li>
<li>Once all users of the old names are gone, remove them.</li>
</ul>
<p>This way drivers/patches in the progress of getting merged won’t break.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="convert-existing-kms-drivers-to-atomic-modesetting">
<h3>Convert existing KMS drivers to atomic modesetting<a class="headerlink" href="#convert-existing-kms-drivers-to-atomic-modesetting" title="Permalink to this headline">¶</a></h3>
<p>3.19 has the atomic modeset interfaces and helpers, so drivers can now be
converted over. Modern compositors like Wayland or Surfaceflinger on Android
really want an atomic modeset interface, so this is all about the bright
future.</p>
<p>There is a conversion guide for atomic and all you need is a GPU for a
non-converted driver (again virtual HW drivers for KVM are still all
suitable).</p>
<p>As part of this drivers also need to convert to universal plane (which means
exposing primary &amp; cursor as proper plane objects). But that’s much easier to
do by directly using the new atomic helper driver callbacks.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
<div class="section" id="clean-up-the-clipped-coordination-confusion-around-planes">
<h3>Clean up the clipped coordination confusion around planes<a class="headerlink" href="#clean-up-the-clipped-coordination-confusion-around-planes" title="Permalink to this headline">¶</a></h3>
<p>We have a helper to get this right with drm_plane_helper_check_update(), but
it’s not consistently used. This should be fixed, preferrably in the atomic
helpers (and drivers then moved over to clipped coordinates). Probably the
helper should also be moved from drm_plane_helper.c to the atomic helpers, to
avoid confusion - the other helpers in that file are all deprecated legacy
helpers.</p>
<p>Contact: Ville Syrjälä, Daniel Vetter, driver maintainers</p>
</div>
<div class="section" id="implement-deferred-fbdev-setup-in-the-helper">
<h3>Implement deferred fbdev setup in the helper<a class="headerlink" href="#implement-deferred-fbdev-setup-in-the-helper" title="Permalink to this headline">¶</a></h3>
<p>Many (especially embedded drivers) want to delay fbdev setup until there’s a
real screen plugged in. This is to avoid the dreaded fallback to the low-res
fbdev default. Many drivers have a hacked-up (and often broken) version of this,
better to do it once in the shared helpers. Thierry has a patch series, but that
one needs to be rebased and final polish applied.</p>
<p>Contact: Thierry Reding, Daniel Vetter, driver maintainers</p>
</div>
<div class="section" id="convert-early-atomic-drivers-to-async-commit-helpers">
<h3>Convert early atomic drivers to async commit helpers<a class="headerlink" href="#convert-early-atomic-drivers-to-async-commit-helpers" title="Permalink to this headline">¶</a></h3>
<p>For the first year the atomic modeset helpers didn’t support asynchronous /
nonblocking commits, and every driver had to hand-roll them. This is fixed
now, but there’s still a pile of existing drivers that easily could be
converted over to the new infrastructure.</p>
<p>One issue with the helpers is that they require that drivers handle completion
events for atomic commits correctly. But fixing these bugs is good anyway.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
<div class="section" id="better-manual-upload-support-for-atomic">
<h3>Better manual-upload support for atomic<a class="headerlink" href="#better-manual-upload-support-for-atomic" title="Permalink to this headline">¶</a></h3>
<p>This would be especially useful for tinydrm:</p>
<ul class="simple">
<li>Add a struct drm_rect dirty_clip to drm_crtc_state. When duplicating the
crtc state, clear that to the max values, x/y = 0 and w/h = MAX_INT, in
__drm_atomic_helper_crtc_duplicate_state().</li>
<li>Move tinydrm_merge_clips into drm_framebuffer.c, dropping the tinydrm_
prefix ofc and using drm_fb_. drm_framebuffer.c makes sense since this
is a function useful to implement the fb-&gt;dirty function.</li>
<li>Create a new drm_fb_dirty function which does essentially what e.g.
mipi_dbi_fb_dirty does. You can use e.g. drm_atomic_helper_update_plane as the
template. But instead of doing a simple full-screen plane update, this new
helper also sets crtc_state-&gt;dirty_clip to the right coordinates. And of
course it needs to check whether the fb is actually active (and maybe where),
so there’s some book-keeping involved. There’s also some good fun involved in
scaling things appropriately. For that case we might simply give up and
declare the entire area covered by the plane as dirty.</li>
</ul>
<p>Contact: Noralf Trønnes, Daniel Vetter</p>
</div>
<div class="section" id="fallout-from-atomic-kms">
<h3>Fallout from atomic KMS<a class="headerlink" href="#fallout-from-atomic-kms" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">drm_atomic_helper.c</span></code> provides a batch of functions which implement legacy
IOCTLs on top of the new atomic driver interface. Which is really nice for
gradual conversion of drivers, but unfortunately the semantic mismatches are
a bit too severe. So there’s some follow-up work to adjust the function
interfaces to fix these issues:</p>
<ul class="simple">
<li>atomic needs the lock acquire context. At the moment that’s passed around
implicitly with some horrible hacks, and it’s also allocate with
<code class="docutils literal"><span class="pre">GFP_NOFAIL</span></code> behind the scenes. All legacy paths need to start allocating
the acquire context explicitly on stack and then also pass it down into
drivers explicitly so that the legacy-on-atomic functions can use them.</li>
<li>A bunch of the vtable hooks are now in the wrong place: DRM has a split
between core vfunc tables (named <code class="docutils literal"><span class="pre">drm_foo_funcs</span></code>), which are used to
implement the userspace ABI. And then there’s the optional hooks for the
helper libraries (name <code class="docutils literal"><span class="pre">drm_foo_helper_funcs</span></code>), which are purely for
internal use. Some of these hooks should be move from <code class="docutils literal"><span class="pre">_funcs</span></code> to
<code class="docutils literal"><span class="pre">_helper_funcs</span></code> since they are not part of the core ABI. There’s a
<code class="docutils literal"><span class="pre">FIXME</span></code> comment in the kerneldoc for each such case in <code class="docutils literal"><span class="pre">drm_crtc.h</span></code>.</li>
<li>There’s a new helper <code class="docutils literal"><span class="pre">drm_atomic_helper_best_encoder()</span></code> which could be
used by all atomic drivers which don’t select the encoder for a given
connector at runtime. That’s almost all of them, and would allow us to get
rid of a lot of <code class="docutils literal"><span class="pre">best_encoder</span></code> boilerplate in drivers.</li>
</ul>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="get-rid-of-dev-struct-mutex-from-gem-drivers">
<h3>Get rid of dev-&gt;struct_mutex from GEM drivers<a class="headerlink" href="#get-rid-of-dev-struct-mutex-from-gem-drivers" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">dev-&gt;struct_mutex</span></code> is the Big DRM Lock from legacy days and infested
everything. Nowadays in modern drivers the only bit where it’s mandatory is
serializing GEM buffer object destruction. Which unfortunately means drivers
have to keep track of that lock and either call <code class="docutils literal"><span class="pre">unreference</span></code> or
<code class="docutils literal"><span class="pre">unreference_locked</span></code> depending upon context.</p>
<p>Core GEM doesn’t have a need for <code class="docutils literal"><span class="pre">struct_mutex</span></code> any more since kernel 4.8,
and there’s a <code class="docutils literal"><span class="pre">gem_free_object_unlocked</span></code> callback for any drivers which are
entirely <code class="docutils literal"><span class="pre">struct_mutex</span></code> free.</p>
<p>For drivers that need <code class="docutils literal"><span class="pre">struct_mutex</span></code> it should be replaced with a driver-
private lock. The tricky part is the BO free functions, since those can’t
reliably take that lock any more. Instead state needs to be protected with
suitable subordinate locks or some cleanup work pushed to a worker thread. For
performance-critical drivers it might also be better to go with a more
fine-grained per-buffer object and per-context lockings scheme. Currently the
following drivers still use <code class="docutils literal"><span class="pre">struct_mutex</span></code>: <code class="docutils literal"><span class="pre">msm</span></code>, <code class="docutils literal"><span class="pre">omapdrm</span></code> and
<code class="docutils literal"><span class="pre">udl</span></code>.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
</div>
<div class="section" id="core-refactorings">
<h2>Core refactorings<a class="headerlink" href="#core-refactorings" title="Permalink to this headline">¶</a></h2>
<div class="section" id="use-new-idr-deletion-interface-to-clean-up-drm-gem-handle-delete">
<h3>Use new IDR deletion interface to clean up drm_gem_handle_delete()<a class="headerlink" href="#use-new-idr-deletion-interface-to-clean-up-drm-gem-handle-delete" title="Permalink to this headline">¶</a></h3>
<p>See the “This is gross” comment – apparently the IDR system now can return an
error code instead of oopsing.</p>
</div>
<div class="section" id="clean-up-the-drm-header-mess">
<h3>Clean up the DRM header mess<a class="headerlink" href="#clean-up-the-drm-header-mess" title="Permalink to this headline">¶</a></h3>
<p>Currently the DRM subsystem has only one global header, <code class="docutils literal"><span class="pre">drmP.h</span></code>. This is
used both for functions exported to helper libraries and drivers and functions
only used internally in the <code class="docutils literal"><span class="pre">drm.ko</span></code> module. The goal would be to move all
header declarations not needed outside of <code class="docutils literal"><span class="pre">drm.ko</span></code> into
<code class="docutils literal"><span class="pre">drivers/gpu/drm/drm_*_internal.h</span></code> header files. <code class="docutils literal"><span class="pre">EXPORT_SYMBOL</span></code> also
needs to be dropped for these functions.</p>
<p>This would nicely tie in with the below task to create kerneldoc after the API
is cleaned up. Or with the “hide legacy cruft better” task.</p>
<p>Note that this is well in progress, but <code class="docutils literal"><span class="pre">drmP.h</span></code> is still huge. The updated
plan is to switch to per-file driver API headers, which will also structure
the kerneldoc better. This should also allow more fine-grained <code class="docutils literal"><span class="pre">#include</span></code>
directives.</p>
<p>In the end no .c file should need to include <code class="docutils literal"><span class="pre">drmP.h</span></code> anymore.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="add-missing-kerneldoc-for-exported-functions">
<h3>Add missing kerneldoc for exported functions<a class="headerlink" href="#add-missing-kerneldoc-for-exported-functions" title="Permalink to this headline">¶</a></h3>
<p>The DRM reference documentation is still lacking kerneldoc in a few areas. The
task would be to clean up interfaces like moving functions around between
files to better group them and improving the interfaces like dropping return
values for functions that never fail. Then write kerneldoc for all exported
functions and an overview section and integrate it all into the drm book.</p>
<p>See <a class="reference external" href="https://dri.freedesktop.org/docs/drm/">https://dri.freedesktop.org/docs/drm/</a> for what’s there already.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="hide-legacy-cruft-better">
<h3>Hide legacy cruft better<a class="headerlink" href="#hide-legacy-cruft-better" title="Permalink to this headline">¶</a></h3>
<p>Way back DRM supported only drivers which shadow-attached to PCI devices with
userspace or fbdev drivers setting up outputs. Modern DRM drivers take charge
of the entire device, you can spot them with the DRIVER_MODESET flag.</p>
<p>Unfortunately there’s still large piles of legacy code around which needs to
be hidden so that driver writers don’t accidentally end up using it. And to
prevent security issues in those legacy IOCTLs from being exploited on modern
drivers. This has multiple possible subtasks:</p>
<ul class="simple">
<li>Extract support code for legacy features into a <code class="docutils literal"><span class="pre">drm-legacy.ko</span></code> kernel
module and compile it only when one of the legacy drivers is enabled.</li>
</ul>
<p>This is mostly done, the only thing left is to split up <code class="docutils literal"><span class="pre">drm_irq.c</span></code> into
legacy cruft and the parts needed by modern KMS drivers.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="make-panic-handling-work">
<h3>Make panic handling work<a class="headerlink" href="#make-panic-handling-work" title="Permalink to this headline">¶</a></h3>
<p>This is a really varied tasks with lots of little bits and pieces:</p>
<ul class="simple">
<li>The panic path can’t be tested currently, leading to constant breaking. The
main issue here is that panics can be triggered from hardirq contexts and
hence all panic related callback can run in hardirq context. It would be
awesome if we could test at least the fbdev helper code and driver code by
e.g. trigger calls through drm debugfs files. hardirq context could be
achieved by using an IPI to the local processor.</li>
<li>There’s a massive confusion of different panic handlers. DRM fbdev emulation
helpers have one, but on top of that the fbcon code itself also has one. We
need to make sure that they stop fighting over each another.</li>
<li><code class="docutils literal"><span class="pre">drm_can_sleep()</span></code> is a mess. It hides real bugs in normal operations and
isn’t a full solution for panic paths. We need to make sure that it only
returns true if there’s a panic going on for real, and fix up all the
fallout.</li>
<li>The panic handler must never sleep, which also means it can’t ever
<code class="docutils literal"><span class="pre">mutex_lock()</span></code>. Also it can’t grab any other lock unconditionally, not
even spinlocks (because NMI and hardirq can panic too). We need to either
make sure to not call such paths, or trylock everything. Really tricky.</li>
<li>For the above locking troubles reasons it’s pretty much impossible to
attempt a synchronous modeset from panic handlers. The only thing we could
try to achive is an atomic <code class="docutils literal"><span class="pre">set_base</span></code> of the primary plane, and hope that
it shows up. Everything else probably needs to be delayed to some worker or
something else which happens later on. Otherwise it just kills the box
harder, prevent the panic from going out on e.g. netconsole.</li>
<li>There’s also proposal for a simplied DRM console instead of the full-blown
fbcon and DRM fbdev emulation. Any kind of panic handling tricks should
obviously work for both console, in case we ever get kmslog merged.</li>
</ul>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="clean-up-the-debugfs-support">
<h3>Clean up the debugfs support<a class="headerlink" href="#clean-up-the-debugfs-support" title="Permalink to this headline">¶</a></h3>
<p>There’s a bunch of issues with it:</p>
<ul class="simple">
<li>The drm_info_list -&gt;show() function doesn’t even bother to cast to the drm
structure for you. This is lazy.</li>
<li>We probably want to have some support for debugfs files on crtc/connectors and
maybe other kms objects directly in core. There’s even drm_print support in
the funcs for these objects to dump kms state, so it’s all there. And then the
-&gt;show() functions should obviously give you a pointer to the right object.</li>
<li>The drm_info_list stuff is centered on drm_minor instead of drm_device. For
anything we want to print drm_device (or maybe drm_file) is the right thing.</li>
<li>The drm_driver-&gt;debugfs_init hooks we have is just an artifact of the old
midlayered load sequence. DRM debugfs should work more like sysfs, where you
can create properties/files for an object anytime you want, and the core
takes care of publishing/unpuplishing all the files at register/unregister
time. Drivers shouldn’t need to worry about these technicalities, and fixing
this (together with the drm_minor-&gt;drm_device move) would allow us to remove
debugfs_init.</li>
</ul>
<p>Contact: Daniel Vetter</p>
</div>
</div>
<div class="section" id="better-testing">
<h2>Better Testing<a class="headerlink" href="#better-testing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="enable-trinity-for-drm">
<h3>Enable trinity for DRM<a class="headerlink" href="#enable-trinity-for-drm" title="Permalink to this headline">¶</a></h3>
<p>And fix up the fallout. Should be really interesting …</p>
</div>
<div class="section" id="make-kms-tests-in-i-g-t-generic">
<h3>Make KMS tests in i-g-t generic<a class="headerlink" href="#make-kms-tests-in-i-g-t-generic" title="Permalink to this headline">¶</a></h3>
<p>The i915 driver team maintains an extensive testsuite for the i915 DRM driver,
including tons of testcases for corner-cases in the modesetting API. It would
be awesome if those tests (at least the ones not relying on Intel-specific GEM
features) could be made to run on any KMS driver.</p>
<p>Basic work to run i-g-t tests on non-i915 is done, what’s now missing is mass-
converting things over. For modeset tests we also first need a bit of
infrastructure to use dumb buffers for untiled buffers, to be able to run all
the non-i915 specific modeset tests.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="create-a-virtual-kms-driver-for-testing-vkms">
<h3>Create a virtual KMS driver for testing (vkms)<a class="headerlink" href="#create-a-virtual-kms-driver-for-testing-vkms" title="Permalink to this headline">¶</a></h3>
<p>With all the latest helpers it should be fairly simple to create a virtual KMS
driver useful for testing, or for running X or similar on headless machines
(to be able to still use the GPU). This would be similar to vgem, but aimed at
the modeset side.</p>
<p>Once the basics are there there’s tons of possibilities to extend it.</p>
<p>Contact: Daniel Vetter</p>
</div>
</div>
<div class="section" id="driver-specific">
<h2>Driver Specific<a class="headerlink" href="#driver-specific" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tinydrm">
<h3>tinydrm<a class="headerlink" href="#tinydrm" title="Permalink to this headline">¶</a></h3>
<p>Tinydrm is the helper driver for really simple fb drivers. The goal is to make
those drivers as simple as possible, so lots of room for refactoring:</p>
<ul class="simple">
<li>backlight helpers, probably best to put them into a new drm_backlight.c.
This is because drivers/video is de-facto unmaintained. We could also
move drivers/video/backlight to drivers/gpu/backlight and take it all
over within drm-misc, but that’s more work.</li>
<li>spi helpers, probably best put into spi core/helper code. Thierry said
the spi maintainer is fast&amp;reactive, so shouldn’t be a big issue.</li>
<li>extract the mipi-dbi helper (well, the non-tinydrm specific parts at
least) into a separate helper, like we have for mipi-dsi already. Or follow
one of the ideas for having a shared dsi/dbi helper, abstracting away the
transport details more.</li>
<li>tinydrm_lastclose could be drm_fb_helper_lastclose. Only thing we need
for that is to store the drm_fb_helper pointer somewhere in
drm_device-&gt;mode_config. And then we could roll that out to all the
drivers.</li>
<li>tinydrm_gem_cma_prime_import_sg_table should probably go into the cma
helpers, as a _vmapped variant (since not every driver needs the vmap).
And tinydrm_gem_cma_free_object could the be merged into
drm_gem_cma_free_object().</li>
<li>tinydrm_fb_create we could move into drm_simple_pipe, only need to add
the fb_create hook to drm_simple_pipe_funcs, which would again simplify a
bunch of things (since it gives you a one-stop vfunc for simple drivers).</li>
<li>Quick aside: The unregister devm stuff is kinda getting the lifetimes of
a drm_device wrong. Doesn’t matter, since everyone else gets it wrong
too :-)</li>
<li>With the fbdev pointer in dev-&gt;mode_config we could also make
suspend/resume helpers entirely generic, at least if we add a
dev-&gt;mode_config.suspend_state. We could even provide a generic pm_ops
structure with those.</li>
<li>also rework the drm_framebuffer_funcs-&gt;dirty hook wire-up, see above.</li>
</ul>
<p>Contact: Noralf Trønnes, Daniel Vetter</p>
</div>
</div>
<div class="section" id="outside-drm">
<h2>Outside DRM<a class="headerlink" href="#outside-drm" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../security/index.html" class="btn btn-neutral float-right" title="Security Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bridge/dw-hdmi.html" class="btn btn-neutral" title="drm/bridge/dw-hdmi Synopsys DesignWare HDMI Controller" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>