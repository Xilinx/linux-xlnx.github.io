

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>User Space Interface &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Programming Interface" href="api.html" />
    <link rel="prev" title="Developing Cipher Algorithms" href="devel-algos.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.14.0-xilinx-v2018.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Kernel Crypto API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Kernel Crypto API Interface Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Kernel Crypto API Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devel-algos.html">Developing Cipher Algorithms</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">User Space Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-space-api-general-remarks">User Space API General Remarks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#in-place-cipher-operation">In-place Cipher operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#message-digest-api">Message Digest API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#symmetric-cipher-api">Symmetric Cipher API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aead-cipher-api">AEAD Cipher API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#aead-memory-structure">AEAD Memory Structure</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#random-number-generator-api">Random Number Generator API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#zero-copy-interface">Zero-Copy Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setsockopt-interface">Setsockopt Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-space-api-example">User space API example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api.html">Programming Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="api-samples.html">Code Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Linux Filesystems API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/ko_KR/index.html">Korean translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/zh_CN/index.html">Chinese translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/ja_JP/index.html">Japanese translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Kernel Crypto API</a> &raquo;</li>
        
      <li>User Space Interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/crypto/userspace-if.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="user-space-interface">
<h1>User Space Interface<a class="headerlink" href="#user-space-interface" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The concepts of the kernel crypto API visible to kernel space is fully
applicable to the user space interface as well. Therefore, the kernel
crypto API high level discussion for the in-kernel use cases applies
here as well.</p>
<p>The major difference, however, is that user space can only act as a
consumer and never as a provider of a transformation or cipher
algorithm.</p>
<p>The following covers the user space interface exported by the kernel
crypto API. A working example of this description is libkcapi that can
be obtained from [1]. That library can be used by user space
applications that require cryptographic services from the kernel.</p>
<p>Some details of the in-kernel kernel crypto API aspects do not apply to
user space, however. This includes the difference between synchronous
and asynchronous invocations. The user space API call is fully
synchronous.</p>
<p>[1] <a class="reference external" href="http://www.chronox.de/libkcapi.html">http://www.chronox.de/libkcapi.html</a></p>
</div>
<div class="section" id="user-space-api-general-remarks">
<h2>User Space API General Remarks<a class="headerlink" href="#user-space-api-general-remarks" title="Permalink to this headline">¶</a></h2>
<p>The kernel crypto API is accessible from user space. Currently, the
following ciphers are accessible:</p>
<ul class="simple">
<li>Message digest including keyed message digest (HMAC, CMAC)</li>
<li>Symmetric ciphers</li>
<li>AEAD ciphers</li>
<li>Random Number Generators</li>
</ul>
<p>The interface is provided via socket type using the type AF_ALG. In
addition, the setsockopt option type is SOL_ALG. In case the user space
header files do not export these flags yet, use the following macros:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>#ifndef AF_ALG
#define AF_ALG 38
#endif
#ifndef SOL_ALG
#define SOL_ALG 279
#endif
</pre></div>
</div>
<p>A cipher is accessed with the same name as done for the in-kernel API
calls. This includes the generic vs. unique naming schema for ciphers as
well as the enforcement of priorities for generic names.</p>
<p>To interact with the kernel crypto API, a socket must be created by the
user space application. User space invokes the cipher operation with the
send()/write() system call family. The result of the cipher operation is
obtained with the read()/recv() system call family.</p>
<p>The following API calls assume that the socket descriptor is already
opened by the user space application and discusses only the kernel
crypto API specific invocations.</p>
<p>To initialize the socket interface, the following sequence has to be
performed by the consumer:</p>
<ol class="arabic simple">
<li>Create a socket of type AF_ALG with the struct sockaddr_alg
parameter specified below for the different cipher types.</li>
<li>Invoke bind with the socket descriptor</li>
<li>Invoke accept with the socket descriptor. The accept system call
returns a new file descriptor that is to be used to interact with the
particular cipher instance. When invoking send/write or recv/read
system calls to send data to the kernel or obtain data from the
kernel, the file descriptor returned by accept must be used.</li>
</ol>
</div>
<div class="section" id="in-place-cipher-operation">
<h2>In-place Cipher operation<a class="headerlink" href="#in-place-cipher-operation" title="Permalink to this headline">¶</a></h2>
<p>Just like the in-kernel operation of the kernel crypto API, the user
space interface allows the cipher operation in-place. That means that
the input buffer used for the send/write system call and the output
buffer used by the read/recv system call may be one and the same. This
is of particular interest for symmetric cipher operations where a
copying of the output data to its final destination can be avoided.</p>
<p>If a consumer on the other hand wants to maintain the plaintext and the
ciphertext in different memory locations, all a consumer needs to do is
to provide different memory pointers for the encryption and decryption
operation.</p>
</div>
<div class="section" id="message-digest-api">
<h2>Message Digest API<a class="headerlink" href="#message-digest-api" title="Permalink to this headline">¶</a></h2>
<p>The message digest type to be used for the cipher operation is selected
when invoking the bind syscall. bind requires the caller to provide a
filled struct sockaddr data structure. This data structure must be
filled as follows:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct sockaddr_alg sa = {
    .salg_family = AF_ALG,
    .salg_type = &quot;hash&quot;, /* this selects the hash logic in the kernel */
    .salg_name = &quot;sha1&quot; /* this is the cipher name */
};
</pre></div>
</div>
<p>The salg_type value “hash” applies to message digests and keyed message
digests. Though, a keyed message digest is referenced by the appropriate
salg_name. Please see below for the setsockopt interface that explains
how the key can be set for a keyed message digest.</p>
<p>Using the send() system call, the application provides the data that
should be processed with the message digest. The send system call allows
the following flags to be specified:</p>
<ul class="simple">
<li>MSG_MORE: If this flag is set, the send system call acts like a
message digest update function where the final hash is not yet
calculated. If the flag is not set, the send system call calculates
the final message digest immediately.</li>
</ul>
<p>With the recv() system call, the application can read the message digest
from the kernel crypto API. If the buffer is too small for the message
digest, the flag MSG_TRUNC is set by the kernel.</p>
<p>In order to set a message digest key, the calling application must use
the setsockopt() option of ALG_SET_KEY. If the key is not set the HMAC
operation is performed without the initial HMAC state change caused by
the key.</p>
</div>
<div class="section" id="symmetric-cipher-api">
<h2>Symmetric Cipher API<a class="headerlink" href="#symmetric-cipher-api" title="Permalink to this headline">¶</a></h2>
<p>The operation is very similar to the message digest discussion. During
initialization, the struct sockaddr data structure must be filled as
follows:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct sockaddr_alg sa = {
    .salg_family = AF_ALG,
    .salg_type = &quot;skcipher&quot;, /* this selects the symmetric cipher */
    .salg_name = &quot;cbc(aes)&quot; /* this is the cipher name */
};
</pre></div>
</div>
<p>Before data can be sent to the kernel using the write/send system call
family, the consumer must set the key. The key setting is described with
the setsockopt invocation below.</p>
<p>Using the sendmsg() system call, the application provides the data that
should be processed for encryption or decryption. In addition, the IV is
specified with the data structure provided by the sendmsg() system call.</p>
<p>The sendmsg system call parameter of struct msghdr is embedded into the
struct cmsghdr data structure. See recv(2) and cmsg(3) for more
information on how the cmsghdr data structure is used together with the
send/recv system call family. That cmsghdr data structure holds the
following information specified with a separate header instances:</p>
<ul class="simple">
<li>specification of the cipher operation type with one of these flags:<ul>
<li>ALG_OP_ENCRYPT - encryption of data</li>
<li>ALG_OP_DECRYPT - decryption of data</li>
</ul>
</li>
<li>specification of the IV information marked with the flag ALG_SET_IV</li>
</ul>
<p>The send system call family allows the following flag to be specified:</p>
<ul class="simple">
<li>MSG_MORE: If this flag is set, the send system call acts like a
cipher update function where more input data is expected with a
subsequent invocation of the send system call.</li>
</ul>
<p>Note: The kernel reports -EINVAL for any unexpected data. The caller
must make sure that all data matches the constraints given in
/proc/crypto for the selected cipher.</p>
<p>With the recv() system call, the application can read the result of the
cipher operation from the kernel crypto API. The output buffer must be
at least as large as to hold all blocks of the encrypted or decrypted
data. If the output data size is smaller, only as many blocks are
returned that fit into that output buffer size.</p>
</div>
<div class="section" id="aead-cipher-api">
<h2>AEAD Cipher API<a class="headerlink" href="#aead-cipher-api" title="Permalink to this headline">¶</a></h2>
<p>The operation is very similar to the symmetric cipher discussion. During
initialization, the struct sockaddr data structure must be filled as
follows:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct sockaddr_alg sa = {
    .salg_family = AF_ALG,
    .salg_type = &quot;aead&quot;, /* this selects the symmetric cipher */
    .salg_name = &quot;gcm(aes)&quot; /* this is the cipher name */
};
</pre></div>
</div>
<p>Before data can be sent to the kernel using the write/send system call
family, the consumer must set the key. The key setting is described with
the setsockopt invocation below.</p>
<p>In addition, before data can be sent to the kernel using the write/send
system call family, the consumer must set the authentication tag size.
To set the authentication tag size, the caller must use the setsockopt
invocation described below.</p>
<p>Using the sendmsg() system call, the application provides the data that
should be processed for encryption or decryption. In addition, the IV is
specified with the data structure provided by the sendmsg() system call.</p>
<p>The sendmsg system call parameter of struct msghdr is embedded into the
struct cmsghdr data structure. See recv(2) and cmsg(3) for more
information on how the cmsghdr data structure is used together with the
send/recv system call family. That cmsghdr data structure holds the
following information specified with a separate header instances:</p>
<ul class="simple">
<li>specification of the cipher operation type with one of these flags:<ul>
<li>ALG_OP_ENCRYPT - encryption of data</li>
<li>ALG_OP_DECRYPT - decryption of data</li>
</ul>
</li>
<li>specification of the IV information marked with the flag ALG_SET_IV</li>
<li>specification of the associated authentication data (AAD) with the
flag ALG_SET_AEAD_ASSOCLEN. The AAD is sent to the kernel together
with the plaintext / ciphertext. See below for the memory structure.</li>
</ul>
<p>The send system call family allows the following flag to be specified:</p>
<ul class="simple">
<li>MSG_MORE: If this flag is set, the send system call acts like a
cipher update function where more input data is expected with a
subsequent invocation of the send system call.</li>
</ul>
<p>Note: The kernel reports -EINVAL for any unexpected data. The caller
must make sure that all data matches the constraints given in
/proc/crypto for the selected cipher.</p>
<p>With the recv() system call, the application can read the result of the
cipher operation from the kernel crypto API. The output buffer must be
at least as large as defined with the memory structure below. If the
output data size is smaller, the cipher operation is not performed.</p>
<p>The authenticated decryption operation may indicate an integrity error.
Such breach in integrity is marked with the -EBADMSG error code.</p>
<div class="section" id="aead-memory-structure">
<h3>AEAD Memory Structure<a class="headerlink" href="#aead-memory-structure" title="Permalink to this headline">¶</a></h3>
<p>The AEAD cipher operates with the following information that is
communicated between user and kernel space as one data stream:</p>
<ul class="simple">
<li>plaintext or ciphertext</li>
<li>associated authentication data (AAD)</li>
<li>authentication tag</li>
</ul>
<p>The sizes of the AAD and the authentication tag are provided with the
sendmsg and setsockopt calls (see there). As the kernel knows the size
of the entire data stream, the kernel is now able to calculate the right
offsets of the data components in the data stream.</p>
<p>The user space caller must arrange the aforementioned information in the
following order:</p>
<ul class="simple">
<li>AEAD encryption input: AAD || plaintext</li>
<li>AEAD decryption input: AAD || ciphertext || authentication tag</li>
</ul>
<p>The output buffer the user space caller provides must be at least as
large to hold the following data:</p>
<ul class="simple">
<li>AEAD encryption output: ciphertext || authentication tag</li>
<li>AEAD decryption output: plaintext</li>
</ul>
</div>
</div>
<div class="section" id="random-number-generator-api">
<h2>Random Number Generator API<a class="headerlink" href="#random-number-generator-api" title="Permalink to this headline">¶</a></h2>
<p>Again, the operation is very similar to the other APIs. During
initialization, the struct sockaddr data structure must be filled as
follows:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct sockaddr_alg sa = {
    .salg_family = AF_ALG,
    .salg_type = &quot;rng&quot;, /* this selects the symmetric cipher */
    .salg_name = &quot;drbg_nopr_sha256&quot; /* this is the cipher name */
};
</pre></div>
</div>
<p>Depending on the RNG type, the RNG must be seeded. The seed is provided
using the setsockopt interface to set the key. For example, the
ansi_cprng requires a seed. The DRBGs do not require a seed, but may be
seeded.</p>
<p>Using the read()/recvmsg() system calls, random numbers can be obtained.
The kernel generates at most 128 bytes in one call. If user space
requires more data, multiple calls to read()/recvmsg() must be made.</p>
<p>WARNING: The user space caller may invoke the initially mentioned accept
system call multiple times. In this case, the returned file descriptors
have the same state.</p>
</div>
<div class="section" id="zero-copy-interface">
<h2>Zero-Copy Interface<a class="headerlink" href="#zero-copy-interface" title="Permalink to this headline">¶</a></h2>
<p>In addition to the send/write/read/recv system call family, the AF_ALG
interface can be accessed with the zero-copy interface of
splice/vmsplice. As the name indicates, the kernel tries to avoid a copy
operation into kernel space.</p>
<p>The zero-copy operation requires data to be aligned at the page
boundary. Non-aligned data can be used as well, but may require more
operations of the kernel which would defeat the speed gains obtained
from the zero-copy interface.</p>
<p>The system-inherent limit for the size of one zero-copy operation is 16
pages. If more data is to be sent to AF_ALG, user space must slice the
input into segments with a maximum size of 16 pages.</p>
<p>Zero-copy can be used with the following code example (a complete
working example is provided with libkcapi):</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>int pipes[2];

pipe(pipes);
/* input data in iov */
vmsplice(pipes[1], iov, iovlen, SPLICE_F_GIFT);
/* opfd is the file descriptor returned from accept() system call */
splice(pipes[0], NULL, opfd, NULL, ret, 0);
read(opfd, out, outlen);
</pre></div>
</div>
</div>
<div class="section" id="setsockopt-interface">
<h2>Setsockopt Interface<a class="headerlink" href="#setsockopt-interface" title="Permalink to this headline">¶</a></h2>
<p>In addition to the read/recv and send/write system call handling to send
and retrieve data subject to the cipher operation, a consumer also needs
to set the additional information for the cipher operation. This
additional information is set using the setsockopt system call that must
be invoked with the file descriptor of the open cipher (i.e. the file
descriptor returned by the accept system call).</p>
<p>Each setsockopt invocation must use the level SOL_ALG.</p>
<p>The setsockopt interface allows setting the following data using the
mentioned optname:</p>
<ul class="simple">
<li>ALG_SET_KEY – Setting the key. Key setting is applicable to:<ul>
<li>the skcipher cipher type (symmetric ciphers)</li>
<li>the hash cipher type (keyed message digests)</li>
<li>the AEAD cipher type</li>
<li>the RNG cipher type to provide the seed</li>
</ul>
</li>
<li>ALG_SET_AEAD_AUTHSIZE – Setting the authentication tag size for
AEAD ciphers. For a encryption operation, the authentication tag of
the given size will be generated. For a decryption operation, the
provided ciphertext is assumed to contain an authentication tag of
the given size (see section about AEAD memory layout below).</li>
</ul>
</div>
<div class="section" id="user-space-api-example">
<h2>User space API example<a class="headerlink" href="#user-space-api-example" title="Permalink to this headline">¶</a></h2>
<p>Please see [1] for libkcapi which provides an easy-to-use wrapper around
the aforementioned Netlink kernel interface. [1] also contains a test
application that invokes all libkcapi API calls.</p>
<p>[1] <a class="reference external" href="http://www.chronox.de/libkcapi.html">http://www.chronox.de/libkcapi.html</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="Programming Interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="devel-algos.html" class="btn btn-neutral" title="Developing Cipher Algorithms" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>