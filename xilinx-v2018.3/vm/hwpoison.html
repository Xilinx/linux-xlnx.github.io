

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>hwpoison &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hugetlbfs Reservation" href="hugetlbfs_reserv.html" />
    <link rel="prev" title="Heterogeneous Memory Management (HMM)" href="hmm.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.19.0-xilinx-v2018.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Linux Filesystems API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Memory Management Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#user-guides-for-mm-features">User guides for MM features</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#kernel-developers-mm-documentation">Kernel developers MM documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="active_mm.html">Active MM</a></li>
<li class="toctree-l3"><a class="reference internal" href="balance.html">Memory Balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="cleancache.html">Cleancache</a></li>
<li class="toctree-l3"><a class="reference internal" href="frontswap.html">Frontswap</a></li>
<li class="toctree-l3"><a class="reference internal" href="highmem.html">High Memory Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="hmm.html">Heterogeneous Memory Management (HMM)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">hwpoison</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-hwpoison">What is hwpoison?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#failure-recovery-modes">Failure recovery modes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-control">User control</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#references">References</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hugetlbfs_reserv.html">Hugetlbfs Reservation</a></li>
<li class="toctree-l3"><a class="reference internal" href="ksm.html">Kernel Samepage Merging</a></li>
<li class="toctree-l3"><a class="reference internal" href="mmu_notifier.html">When do you need to notify inside page table lock ?</a></li>
<li class="toctree-l3"><a class="reference internal" href="numa.html">What is NUMA?</a></li>
<li class="toctree-l3"><a class="reference internal" href="overcommit-accounting.html">Overcommit Accounting</a></li>
<li class="toctree-l3"><a class="reference internal" href="page_migration.html">Page migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="page_frags.html">Page fragments</a></li>
<li class="toctree-l3"><a class="reference internal" href="page_owner.html">page owner: Tracking about who allocated each page</a></li>
<li class="toctree-l3"><a class="reference internal" href="remap_file_pages.html">remap_file_pages() system call</a></li>
<li class="toctree-l3"><a class="reference internal" href="slub.html">Short users guide for SLUB</a></li>
<li class="toctree-l3"><a class="reference internal" href="split_page_table_lock.html">Split page table lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="transhuge.html">Transparent Hugepage Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="unevictable-lru.html">Unevictable LRU Infrastructure</a></li>
<li class="toctree-l3"><a class="reference internal" href="z3fold.html">z3fold</a></li>
<li class="toctree-l3"><a class="reference internal" href="zsmalloc.html">zsmalloc</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Filesystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Memory Management Documentation</a> &raquo;</li>
        
      <li>hwpoison</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/vm/hwpoison.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hwpoison">
<h1>hwpoison<a class="headerlink" href="#hwpoison" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-hwpoison">
<h2>What is hwpoison?<a class="headerlink" href="#what-is-hwpoison" title="Permalink to this headline">¶</a></h2>
<p>Upcoming Intel CPUs have support for recovering from some memory errors
(<code class="docutils literal"><span class="pre">MCA</span> <span class="pre">recovery</span></code>). This requires the OS to declare a page “poisoned”,
kill the processes associated with it and avoid using it in the future.</p>
<p>This patchkit implements the necessary infrastructure in the VM.</p>
<p>To quote the overview comment:</p>
<blockquote>
<div><ul class="simple">
<li>High level machine check handler. Handles pages reported by the</li>
<li>hardware as being corrupted usually due to a 2bit ECC memory or cache</li>
<li>failure.</li>
<li></li>
<li>This focusses on pages detected as corrupted in the background.</li>
<li>When the current CPU tries to consume corruption the currently</li>
<li>running process can just be killed directly instead. This implies</li>
<li>that if the error cannot be handled for some reason it’s safe to</li>
<li>just ignore it because no corruption has been consumed yet. Instead</li>
<li>when that happens another machine check will happen.</li>
<li></li>
<li>Handles page cache pages in various states. The tricky part</li>
<li>here is that we can access any page asynchronous to other VM</li>
<li>users, because memory failures could happen anytime and anywhere,</li>
<li>possibly violating some of their assumptions. This is why this code</li>
<li>has to be extremely careful. Generally it tries to use normal locking</li>
<li>rules, as in get the standard locks, even if that means the</li>
<li>error handling takes potentially a long time.</li>
<li></li>
<li>Some of the operations here are somewhat inefficient and have non</li>
<li>linear algorithmic complexity, because the data structures have not</li>
<li>been optimized for this case. This is in particular the case</li>
<li>for the mapping from a vma to a process. Since this case is expected</li>
<li>to be rare we hope we can get away with this.</li>
</ul>
</div></blockquote>
<p>The code consists of a the high level handler in mm/memory-failure.c,
a new page poison bit and various checks in the VM to handle poisoned
pages.</p>
<p>The main target right now is KVM guests, but it works for all kinds
of applications. KVM support requires a recent qemu-kvm release.</p>
<p>For the KVM use there was need for a new signal type so that
KVM can inject the machine check into the guest with the proper
address. This in theory allows other applications to handle
memory failures too. The expection is that near all applications
won’t do that, but some very specialized ones might.</p>
</div>
<div class="section" id="failure-recovery-modes">
<h2>Failure recovery modes<a class="headerlink" href="#failure-recovery-modes" title="Permalink to this headline">¶</a></h2>
<p>There are two (actually three) modes memory failure recovery can be in:</p>
<dl class="docutils">
<dt>vm.memory_failure_recovery sysctl set to zero:</dt>
<dd>All memory failures cause a panic. Do not attempt recovery.
(on x86 this can be also affected by the tolerant level of the
MCE subsystem)</dd>
<dt>early kill</dt>
<dd>(can be controlled globally and per process)
Send SIGBUS to the application as soon as the error is detected
This allows applications who can process memory errors in a gentle
way (e.g. drop affected object)
This is the mode used by KVM qemu.</dd>
<dt>late kill</dt>
<dd>Send SIGBUS when the application runs into the corrupted page.
This is best for memory error unaware applications and default
Note some pages are always handled as late kill.</dd>
</dl>
</div>
<div class="section" id="user-control">
<h2>User control<a class="headerlink" href="#user-control" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>vm.memory_failure_recovery</dt>
<dd>See sysctl.txt</dd>
<dt>vm.memory_failure_early_kill</dt>
<dd>Enable early kill mode globally</dd>
<dt>PR_MCE_KILL</dt>
<dd><p class="first">Set early/late kill mode/revert to system default</p>
<dl class="docutils">
<dt>arg1: PR_MCE_KILL_CLEAR:</dt>
<dd>Revert to system default</dd>
<dt>arg1: PR_MCE_KILL_SET:</dt>
<dd><p class="first">arg2 defines thread specific mode</p>
<dl class="last docutils">
<dt>PR_MCE_KILL_EARLY:</dt>
<dd>Early kill</dd>
<dt>PR_MCE_KILL_LATE:</dt>
<dd>Late kill</dd>
<dt>PR_MCE_KILL_DEFAULT</dt>
<dd>Use system global default</dd>
</dl>
</dd>
</dl>
<p class="last">Note that if you want to have a dedicated thread which handles
the SIGBUS(BUS_MCEERR_AO) on behalf of the process, you should
call prctl(PR_MCE_KILL_EARLY) on the designated thread. Otherwise,
the SIGBUS is sent to the main thread.</p>
</dd>
<dt>PR_MCE_KILL_GET</dt>
<dd>return current mode</dd>
</dl>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">madvise(MADV_HWPOISON, ….) (as root) - Poison a page in the
process for testing</p>
</li>
<li><p class="first">hwpoison-inject module through debugfs <code class="docutils literal"><span class="pre">/sys/kernel/debug/hwpoison/</span></code></p>
<dl class="docutils">
<dt>corrupt-pfn</dt>
<dd><p class="first last">Inject hwpoison fault at PFN echoed into this file. This does
some early filtering to avoid corrupted unintended pages in test suites.</p>
</dd>
<dt>unpoison-pfn</dt>
<dd><p class="first last">Software-unpoison page at PFN echoed into this file. This way
a page can be reused again.  This only works for Linux
injected failures, not for real memory failures.</p>
</dd>
</dl>
<p>Note these injection interfaces are not stable and might change between
kernel versions</p>
<dl class="docutils">
<dt>corrupt-filter-dev-major, corrupt-filter-dev-minor</dt>
<dd><p class="first last">Only handle memory failures to pages associated with the file
system defined by block device major/minor.  -1U is the
wildcard value.  This should be only used for testing with
artificial injection.</p>
</dd>
<dt>corrupt-filter-memcg</dt>
<dd><p class="first">Limit injection to pages owned by memgroup. Specified by inode
number of the memcg.</p>
<p>Example:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>mkdir /sys/fs/cgroup/mem/hwpoison

usemem -m 100 -s 1000 &amp;
echo `jobs -p` &gt; /sys/fs/cgroup/mem/hwpoison/tasks

memcg_ino=$(ls -id /sys/fs/cgroup/mem/hwpoison | cut -f1 -d&#39; &#39;)
echo $memcg_ino &gt; /debug/hwpoison/corrupt-filter-memcg

page-types -p `pidof init`   --hwpoison  # shall do nothing
page-types -p `pidof usemem` --hwpoison  # poison its pages
</pre></div>
</div>
</dd>
<dt>corrupt-filter-flags-mask, corrupt-filter-flags-value</dt>
<dd><p class="first last">When specified, only poison pages if ((page_flags &amp; mask) ==
value).  This allows stress testing of many kinds of
pages. The page_flags are the same as in /proc/kpageflags. The
flag bits are defined in include/linux/kernel-page-flags.h and
documented in Documentation/admin-guide/mm/pagemap.rst</p>
</dd>
</dl>
</li>
<li><p class="first">Architecture specific MCE injector</p>
<p>x86 has mce-inject, mce-test</p>
<p>Some portable hwpoison test programs in mce-test, see below.</p>
</li>
</ul>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><a class="reference external" href="http://halobates.de/mce-lc09-2.pdf">http://halobates.de/mce-lc09-2.pdf</a></dt>
<dd>Overview presentation from LinuxCon 09</dd>
<dt>git://git.kernel.org/pub/scm/utils/cpu/mce/mce-test.git</dt>
<dd>Test suite (hwpoison specific portable tests in tsrc)</dd>
<dt>git://git.kernel.org/pub/scm/utils/cpu/mce/mce-inject.git</dt>
<dd>x86 specific injector</dd>
</dl>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Not all page types are supported and never will. Most kernel internal
objects cannot be recovered, only LRU pages for now.</li>
<li>Right now hugepage support is missing.</li>
</ul>
<p>—
Andi Kleen, Oct 2009</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="hugetlbfs_reserv.html" class="btn btn-neutral float-right" title="Hugetlbfs Reservation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="hmm.html" class="btn btn-neutral" title="Heterogeneous Memory Management (HMM)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>