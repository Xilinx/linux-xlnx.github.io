

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The errseq_t datatype &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to get printk format specifiers right" href="printk-formats.html" />
    <link rel="prev" title="The genalloc/genpool subsystem" href="genalloc.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.19.0-xilinx-v2018.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Core API Documentation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#core-utilities">Core utilities</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="kernel-api.html">The Linux Kernel API</a></li>
<li class="toctree-l3"><a class="reference internal" href="assoc_array.html">Generic Associative Array Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="atomic_ops.html">Semantics and Behavior of Atomic and Bitmask Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="cachetlb.html">Cache and TLB Flushing Under Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="refcount-vs-atomic.html">refcount_t API compared to atomic_t</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu_hotplug.html">CPU hotplug in the Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="idr.html">ID Allocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="local_ops.html">Semantics and Behavior of Local Atomic Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="workqueue.html">Concurrency Managed Workqueue (cmwq)</a></li>
<li class="toctree-l3"><a class="reference internal" href="genericirq.html">Linux generic IRQ handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="flexible-arrays.html">Using flexible arrays in the kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="librs.html">Reed-Solomon Library Programming Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="genalloc.html">The genalloc/genpool subsystem</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">The errseq_t datatype</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#api-usage">API usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#serializing-errseq-t-cursor-updates">Serializing errseq_t cursor updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="printk-formats.html">How to get printk format specifiers right</a></li>
<li class="toctree-l3"><a class="reference internal" href="circular-buffers.html">Circular Buffers</a></li>
<li class="toctree-l3"><a class="reference internal" href="mm-api.html">Memory Management APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="gfp_mask-from-fs-io.html">GFP masks used from FS/IO context</a></li>
<li class="toctree-l3"><a class="reference internal" href="timekeeping.html">ktime accessors</a></li>
<li class="toctree-l3"><a class="reference internal" href="boot-time-mm.html">Boot time memory management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#interfaces-for-kernel-debugging">Interfaces for kernel debugging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Linux Filesystems API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Filesystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Core API Documentation</a> &raquo;</li>
        
      <li>The errseq_t datatype</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/core-api/errseq.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-errseq-t-datatype">
<h1>The errseq_t datatype<a class="headerlink" href="#the-errseq-t-datatype" title="Permalink to this headline">¶</a></h1>
<p>An errseq_t is a way of recording errors in one place, and allowing any
number of “subscribers” to tell whether it has changed since a previous
point where it was sampled.</p>
<p>The initial use case for this is tracking errors for file
synchronization syscalls (fsync, fdatasync, msync and sync_file_range),
but it may be usable in other situations.</p>
<p>It’s implemented as an unsigned 32-bit value.  The low order bits are
designated to hold an error code (between 1 and MAX_ERRNO).  The upper bits
are used as a counter.  This is done with atomics instead of locking so that
these functions can be called from any context.</p>
<p>Note that there is a risk of collisions if new errors are being recorded
frequently, since we have so few bits to use as a counter.</p>
<p>To mitigate this, the bit between the error value and counter is used as
a flag to tell whether the value has been sampled since a new value was
recorded.  That allows us to avoid bumping the counter if no one has
sampled it since the last time an error was recorded.</p>
<p>Thus we end up with a value that looks something like this:</p>
<table border="1" class="docutils">
<colgroup>
<col width="58%" />
<col width="6%" />
<col width="36%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>31..13</td>
<td>12</td>
<td>11..0</td>
</tr>
<tr class="row-even"><td>counter</td>
<td>SF</td>
<td>errno</td>
</tr>
</tbody>
</table>
<p>The general idea is for “watchers” to sample an errseq_t value and keep
it as a running cursor.  That value can later be used to tell whether
any new errors have occurred since that sampling was done, and atomically
record the state at the time that it was checked.  This allows us to
record errors in one place, and then have a number of “watchers” that
can tell whether the value has changed since they last checked it.</p>
<p>A new errseq_t should always be zeroed out.  An errseq_t value of all zeroes
is the special (but common) case where there has never been an error. An all
zero value thus serves as the “epoch” if one wishes to know whether there
has ever been an error set since it was first initialized.</p>
<div class="section" id="api-usage">
<h2>API usage<a class="headerlink" href="#api-usage" title="Permalink to this headline">¶</a></h2>
<p>Let me tell you a story about a worker drone.  Now, he’s a good worker
overall, but the company is a little…management heavy.  He has to
report to 77 supervisors today, and tomorrow the “big boss” is coming in
from out of town and he’s sure to test the poor fellow too.</p>
<p>They’re all handing him work to do – so much he can’t keep track of who
handed him what, but that’s not really a big problem.  The supervisors
just want to know when he’s finished all of the work they’ve handed him so
far and whether he made any mistakes since they last asked.</p>
<p>He might have made the mistake on work they didn’t actually hand him,
but he can’t keep track of things at that level of detail, all he can
remember is the most recent mistake that he made.</p>
<p>Here’s our worker_drone representation:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct worker_drone {
        errseq_t        wd_err; /* for recording errors */
};
</pre></div>
</div>
<p>Every day, the worker_drone starts out with a blank slate:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct worker_drone wd;

wd.wd_err = (errseq_t)0;
</pre></div>
</div>
<p>The supervisors come in and get an initial read for the day.  They
don’t care about anything that happened before their watch begins:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct supervisor {
        errseq_t        s_wd_err; /* private &quot;cursor&quot; for wd_err */
        spinlock_t      s_wd_err_lock; /* protects s_wd_err */
}

struct supervisor       su;

su.s_wd_err = errseq_sample(&amp;wd.wd_err);
spin_lock_init(&amp;su.s_wd_err_lock);
</pre></div>
</div>
<p>Now they start handing him tasks to do.  Every few minutes they ask him to
finish up all of the work they’ve handed him so far.  Then they ask him
whether he made any mistakes on any of it:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>spin_lock(&amp;su.su_wd_err_lock);
err = errseq_check_and_advance(&amp;wd.wd_err, &amp;su.s_wd_err);
spin_unlock(&amp;su.su_wd_err_lock);
</pre></div>
</div>
<p>Up to this point, that just keeps returning 0.</p>
<p>Now, the owners of this company are quite miserly and have given him
substandard equipment with which to do his job. Occasionally it
glitches and he makes a mistake.  He sighs a heavy sigh, and marks it
down:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>errseq_set(&amp;wd.wd_err, -EIO);
</pre></div>
</div>
<p>…and then gets back to work.  The supervisors eventually poll again
and they each get the error when they next check.  Subsequent calls will
return 0, until another error is recorded, at which point it’s reported
to each of them once.</p>
<p>Note that the supervisors can’t tell how many mistakes he made, only
whether one was made since they last checked, and the latest value
recorded.</p>
<p>Occasionally the big boss comes in for a spot check and asks the worker
to do a one-off job for him. He’s not really watching the worker
full-time like the supervisors, but he does need to know whether a
mistake occurred while his job was processing.</p>
<p>He can just sample the current errseq_t in the worker, and then use that
to tell whether an error has occurred later:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>errseq_t since = errseq_sample(&amp;wd.wd_err);
/* submit some work and wait for it to complete */
err = errseq_check(&amp;wd.wd_err, since);
</pre></div>
</div>
<p>Since he’s just going to discard “since” after that point, he doesn’t
need to advance it here. He also doesn’t need any locking since it’s
not usable by anyone else.</p>
</div>
<div class="section" id="serializing-errseq-t-cursor-updates">
<h2>Serializing errseq_t cursor updates<a class="headerlink" href="#serializing-errseq-t-cursor-updates" title="Permalink to this headline">¶</a></h2>
<p>Note that the errseq_t API does not protect the errseq_t cursor during a
check_and_advance_operation. Only the canonical error code is handled
atomically.  In a situation where more than one task might be using the
same errseq_t cursor at the same time, it’s important to serialize
updates to that cursor.</p>
<p>If that’s not done, then it’s possible for the cursor to go backward
in which case the same error could be reported more than once.</p>
<p>Because of this, it’s often advantageous to first do an errseq_check to
see if anything has changed, and only later do an
errseq_check_and_advance after taking the lock. e.g.:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>if (errseq_check(&amp;wd.wd_err, READ_ONCE(su.s_wd_err)) {
        /* su.s_wd_err is protected by s_wd_err_lock */
        spin_lock(&amp;su.s_wd_err_lock);
        err = errseq_check_and_advance(&amp;wd.wd_err, &amp;su.s_wd_err);
        spin_unlock(&amp;su.s_wd_err_lock);
}
</pre></div>
</div>
<p>That avoids the spinlock in the common case where nothing has changed
since the last time it was checked.</p>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="c.errseq_set">
errseq_t <code class="descname">errseq_set</code><span class="sig-paren">(</span>errseq_t *<em>&nbsp;eseq</em>, int<em>&nbsp;err</em><span class="sig-paren">)</span><a class="headerlink" href="#c.errseq_set" title="Permalink to this definition">¶</a></dt>
<dd><p>set a errseq_t for later reporting</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">errseq_t</span> <span class="pre">*</span> <span class="pre">eseq</span></code></dt>
<dd>errseq_t field that should be set</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">err</span></code></dt>
<dd>error to set (must be between -1 and -MAX_ERRNO)</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function sets the error in <strong>eseq</strong>, and increments the sequence counter
if the last sequence was sampled at some point in the past.</p>
<p>Any error set will always overwrite an existing error.</p>
<p><strong>Return</strong></p>
<p>The previous value, primarily for debugging purposes. The
return value should not be used as a previously sampled value in later
calls as it will not have the SEEN flag set.</p>
<dl class="function">
<dt id="c.errseq_sample">
errseq_t <code class="descname">errseq_sample</code><span class="sig-paren">(</span>errseq_t *<em>&nbsp;eseq</em><span class="sig-paren">)</span><a class="headerlink" href="#c.errseq_sample" title="Permalink to this definition">¶</a></dt>
<dd><p>Grab current errseq_t value.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">errseq_t</span> <span class="pre">*</span> <span class="pre">eseq</span></code></dt>
<dd>Pointer to errseq_t to be sampled.</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function allows callers to initialise their errseq_t variable.
If the error has been “seen”, new callers will not see an old error.
If there is an unseen error in <strong>eseq</strong>, the caller of this function will
see it the next time it checks for an error.</p>
<p><strong>Context</strong></p>
<p>Any context.</p>
<p><strong>Return</strong></p>
<p>The current errseq value.</p>
<dl class="function">
<dt id="c.errseq_check">
int <code class="descname">errseq_check</code><span class="sig-paren">(</span>errseq_t *<em>&nbsp;eseq</em>, errseq_t<em>&nbsp;since</em><span class="sig-paren">)</span><a class="headerlink" href="#c.errseq_check" title="Permalink to this definition">¶</a></dt>
<dd><p>Has an error occurred since a particular sample point?</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">errseq_t</span> <span class="pre">*</span> <span class="pre">eseq</span></code></dt>
<dd>Pointer to errseq_t value to be checked.</dd>
<dt><code class="docutils literal"><span class="pre">errseq_t</span> <span class="pre">since</span></code></dt>
<dd>Previously-sampled errseq_t from which to check.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Grab the value that eseq points to, and see if it has changed <strong>since</strong>
the given value was sampled. The <strong>since</strong> value is not advanced, so there
is no need to mark the value as seen.</p>
<p><strong>Return</strong></p>
<p>The latest error set in the errseq_t or 0 if it hasn’t changed.</p>
<dl class="function">
<dt id="c.errseq_check_and_advance">
int <code class="descname">errseq_check_and_advance</code><span class="sig-paren">(</span>errseq_t *<em>&nbsp;eseq</em>, errseq_t *<em>&nbsp;since</em><span class="sig-paren">)</span><a class="headerlink" href="#c.errseq_check_and_advance" title="Permalink to this definition">¶</a></dt>
<dd><p>Check an errseq_t and advance to current value.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">errseq_t</span> <span class="pre">*</span> <span class="pre">eseq</span></code></dt>
<dd>Pointer to value being checked and reported.</dd>
<dt><code class="docutils literal"><span class="pre">errseq_t</span> <span class="pre">*</span> <span class="pre">since</span></code></dt>
<dd>Pointer to previously-sampled errseq_t to check against and advance.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Grab the eseq value, and see whether it matches the value that <strong>since</strong>
points to. If it does, then just return 0.</p>
<p>If it doesn’t, then the value has changed. Set the “seen” flag, and try to
swap it into place as the new eseq value. Then, set that value as the new
“since” value, and return whatever the error portion is set to.</p>
<p>Note that no locking is provided here for concurrent updates to the “since”
value. The caller must provide that if necessary. Because of this, callers
may want to do a lockless errseq_check before taking the lock and calling
this.</p>
<p><strong>Return</strong></p>
<p>Negative errno if one has been stored, or 0 if no new error has
occurred.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="printk-formats.html" class="btn btn-neutral float-right" title="How to get printk format specifiers right" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="genalloc.html" class="btn btn-neutral" title="The genalloc/genpool subsystem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>