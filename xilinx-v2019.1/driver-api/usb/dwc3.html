

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller &mdash; The Linux Kernel  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
    <link rel="top" title="The Linux Kernel  documentation" href="../../index.html"/>
        <link rel="up" title="Linux USB API" href="index.html"/>
        <link rel="next" title="Writing a MUSB Glue Layer" href="writing_musb_glue_layer.html"/>
        <link rel="prev" title="Writing USB Device Drivers" href="writing_usb_driver.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.19.0-xilinx-v2019.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Linux kernel licensing rules</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user&#8217;s and administrator&#8217;s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux driver implementer&#8217;s API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../basics.html">Driver Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infrastructure.html">Device drivers infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Device Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clk.html">The Common Clk Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device-io.html">Bus-Independent Device Accesses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_connection.html">Device connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dma-buf.html">Buffer Sharing and Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_link.html">Device links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../message-based.html">Message-based devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sound.html">Sound Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frame-buffer.html">Frame Buffer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regulator.html">Voltage and current regulator API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input.html">Input Subsystem</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Linux USB API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="usb.html">The Linux-USB Host Side API</a></li>
<li class="toctree-l3"><a class="reference internal" href="gadget.html">USB Gadget API for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="anchors.html">USB Anchors</a></li>
<li class="toctree-l3"><a class="reference internal" href="bulk-streams.html">USB bulk streams</a></li>
<li class="toctree-l3"><a class="reference internal" href="callbacks.html">USB core callbacks</a></li>
<li class="toctree-l3"><a class="reference internal" href="dma.html">USB DMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="URB.html">USB Request Block (URB)</a></li>
<li class="toctree-l3"><a class="reference internal" href="power-management.html">Power Management for USB</a></li>
<li class="toctree-l3"><a class="reference internal" href="hotplug.html">USB hotplugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="persist.html">USB device persistence during system suspend</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-codes.html">USB Error codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing_usb_driver.html">Writing USB Device Drivers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Synopsys DesignWare Core SuperSpeed USB 3.0 Controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary-of-features">Summary of Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#driver-design">Driver Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#known-limitations">Known Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging">Debugging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#structures-methods-and-definitions">Structures, Methods and Definitions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="writing_musb_glue_layer.html">Writing a MUSB Glue Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="typec.html">USB Type-C connector class</a></li>
<li class="toctree-l3"><a class="reference internal" href="usb3-debug-port.html">USB3 debug port</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pci.html">PCI Support Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci.html#pci-hotplug-support-library">PCI Hotplug Support Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">I<sup>2</sup>C and SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hsi.html">High Speed Synchronous Serial Interface (HSI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac.html">Error Detection And Correction (EDAC) Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scsi.html">SCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libata.html">libATA Developer&#8217;s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target.html">target and iSCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtdnand.html">MTD NAND Driver Programming Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html">Parallel Port Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#x50-uart-driver">16x50 UART Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#pulse-width-modulation-pwm">Pulse-Width Modulation (PWM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../w1.html">W1: Dallas&#8217; 1-wire bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rapidio.html">RapidIO Subsystem Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s390-drivers.html">Writing s390 channel device drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vme.html">VME Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../80211/index.html">Linux 802.11 Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uio-howto.html">The Userspace I/O HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../firmware/index.html">Linux Firmware API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctl.html">PINCTRL (PIN CONTROL) subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpio/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc_devices.html">Miscellaneous Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dmaengine/index.html">DMAEngine documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../soundwire/index.html">SoundWire Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fpga/index.html">FPGA Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Linux Filesystems API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Filesystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">The Linux Kernel</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">The Linux driver implementer&#8217;s API guide</a> &raquo;</li>
      
          <li><a href="index.html">Linux USB API</a> &raquo;</li>
      
    <li>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/driver-api/usb/dwc3.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="synopsys-designware-core-superspeed-usb-3-0-controller">
<h1>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller<a class="headerlink" href="#synopsys-designware-core-superspeed-usb-3-0-controller" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Felipe Balbi &lt;<a class="reference external" href="mailto:felipe&#46;balbi&#37;&#52;&#48;linux&#46;intel&#46;com">felipe<span>&#46;</span>balbi<span>&#64;</span>linux<span>&#46;</span>intel<span>&#46;</span>com</a>&gt;</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">April 2017</td>
</tr>
</tbody>
</table>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The <em>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller</em>
(hereinafter referred to as <em>DWC3</em>) is a USB SuperSpeed compliant
controller which can be configured in one of 4 ways:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Peripheral-only configuration</li>
<li>Host-only configuration</li>
<li>Dual-Role configuration</li>
<li>Hub configuration</li>
</ol>
</div></blockquote>
<p>Linux currently supports several versions of this controller. In all
likelyhood, the version in your SoC is already supported. At the time
of this writing, known tested versions range from 2.02a to 3.10a. As a
rule of thumb, anything above 2.02a should work reliably well.</p>
<p>Currently, we have many known users for this driver. In alphabetical
order:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Cavium</li>
<li>Intel Corporation</li>
<li>Qualcomm</li>
<li>Rockchip</li>
<li>ST</li>
<li>Samsung</li>
<li>Texas Instruments</li>
<li>Xilinx</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="summary-of-features">
<h2>Summary of Features<a class="headerlink" href="#summary-of-features" title="Permalink to this headline">¶</a></h2>
<p>For details about features supported by your version of DWC3, consult
your IP team and/or <em>Synopsys DesignWare Core SuperSpeed USB 3.0
Controller Databook</em>. Following is a list of features supported by the
driver at the time of this writing:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Up to 16 bidirectional endpoints (including the control
pipe - ep0)</li>
<li>Flexible endpoint configuration</li>
<li>Simultaneous IN and OUT transfer support</li>
<li>Scatter-list support</li>
<li>Up to 256 TRBs <a class="footnote-reference" href="#trb" id="id1">[1]</a> per endpoint</li>
<li>Support for all transfer types (<em>Control</em>, <em>Bulk</em>,
<em>Interrupt</em>, and <em>Isochronous</em>)</li>
<li>SuperSpeed Bulk Streams</li>
<li>Link Power Management</li>
<li>Trace Events for debugging</li>
<li>DebugFS <a class="footnote-reference" href="#id9" id="id2">[3]</a> interface</li>
</ol>
</div></blockquote>
<p>These features have all been exercised with many of the <strong>in-tree</strong>
gadget drivers. We have verified both <em>ConfigFS</em> <a class="footnote-reference" href="#configfs" id="id3">[4]</a> and
legacy gadget drivers.</p>
</div>
<div class="section" id="driver-design">
<h2>Driver Design<a class="headerlink" href="#driver-design" title="Permalink to this headline">¶</a></h2>
<p>The DWC3 driver sits on the <em>drivers/usb/dwc3/</em> directory. All files
related to this driver are in this one directory. This makes it easy
for new-comers to read the code and understand how it behaves.</p>
<p>Because of DWC3&#8217;s configuration flexibility, the driver is a little
complex in some places but it should be rather straightforward to
understand.</p>
<p>The biggest part of the driver refers to the Gadget API.</p>
</div>
<div class="section" id="known-limitations">
<h2>Known Limitations<a class="headerlink" href="#known-limitations" title="Permalink to this headline">¶</a></h2>
<p>Like any other HW, DWC3 has its own set of limitations. To avoid
constant questions about such problems, we decided to document them
here and have a single location to where we could point users.</p>
<div class="section" id="out-transfer-size-requirements">
<h3>OUT Transfer Size Requirements<a class="headerlink" href="#out-transfer-size-requirements" title="Permalink to this headline">¶</a></h3>
<p>According to Synopsys Databook, all OUT transfer TRBs <a class="footnote-reference" href="#trb" id="id4">[1]</a> must
have their <em>size</em> field set to a value which is integer divisible by
the endpoint&#8217;s <em>wMaxPacketSize</em>. This means that <em>e.g.</em> in order to
receive a Mass Storage <em>CBW</em> <a class="footnote-reference" href="#cbw" id="id5">[5]</a>, req-&gt;length must either be set
to a value that&#8217;s divisible by <em>wMaxPacketSize</em> (1024 on SuperSpeed,
512 on HighSpeed, etc), or DWC3 driver must add a Chained TRB pointing
to a throw-away buffer for the remaining length. Without this, OUT
transfers will <strong>NOT</strong> start.</p>
<p>Note that as of this writing, this won&#8217;t be a problem because DWC3 is
fully capable of appending a chained TRB for the remaining length and
completely hide this detail from the gadget driver. It&#8217;s still worth
mentioning because this seems to be the largest source of queries
about DWC3 and <em>non-working transfers</em>.</p>
</div>
<div class="section" id="trb-ring-size-limitation">
<h3>TRB Ring Size Limitation<a class="headerlink" href="#trb-ring-size-limitation" title="Permalink to this headline">¶</a></h3>
<p>We, currently, have a hard limit of 256 TRBs <a class="footnote-reference" href="#trb" id="id6">[1]</a> per endpoint,
with the last TRB being a Link TRB <a class="footnote-reference" href="#link-trb" id="id7">[2]</a> pointing back to the
first. This limit is arbitrary but it has the benefit of adding up to
exactly 4096 bytes, or 1 Page.</p>
<p>DWC3 driver will try its best to cope with more than 255 requests and,
for the most part, it should work normally. However this is not
something that has been exercised very frequently. If you experience
any problems, see section <strong>Reporting Bugs</strong> below.</p>
</div>
</div>
<div class="section" id="reporting-bugs">
<h2>Reporting Bugs<a class="headerlink" href="#reporting-bugs" title="Permalink to this headline">¶</a></h2>
<p>Whenever you encounter a problem with DWC3, first and foremost you
should make sure that:</p>
<blockquote>
<div><ol class="arabic simple">
<li>You&#8217;re running latest tag from <a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/">Linus&#8217; tree</a></li>
<li>You can reproduce the error without any out-of-tree changes
to DWC3</li>
<li>You have checked that it&#8217;s not a fault on the host machine</li>
</ol>
</div></blockquote>
<p>After all these are verified, then here&#8217;s how to capture enough
information so we can be of any help to you.</p>
<div class="section" id="required-information">
<h3>Required Information<a class="headerlink" href="#required-information" title="Permalink to this headline">¶</a></h3>
<p>DWC3 relies exclusively on Trace Events for debugging. Everything is
exposed there, with some extra bits being exposed to DebugFS
<a class="footnote-reference" href="#id9" id="id8">[3]</a>.</p>
<p>In order to capture DWC3&#8217;s Trace Events you should run the following
commands <strong>before</strong> plugging the USB cable to a host machine:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c1"># mkdir -p /d</span>
<span class="c1"># mkdir -p /t</span>
<span class="c1"># mount -t debugfs none /d</span>
<span class="c1"># mount -t tracefs none /t</span>
<span class="c1"># echo 81920 &gt; /t/buffer_size_kb</span>
<span class="c1"># echo 1 &gt; /t/events/dwc3/enable</span>
</pre></div>
</div>
<p>After this is done, you can connect your USB cable and reproduce the
problem. As soon as the fault is reproduced, make a copy of files
<code class="docutils literal"><span class="pre">trace</span></code> and <code class="docutils literal"><span class="pre">regdump</span></code>, like so:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c1"># cp /t/trace /root/trace.txt</span>
<span class="c1"># cat /d/*dwc3*/regdump &gt; /root/regdump.txt</span>
</pre></div>
</div>
<p>Make sure to compress <code class="docutils literal"><span class="pre">trace.txt</span></code> and <code class="docutils literal"><span class="pre">regdump.txt</span></code> in a tarball
and email it to <a class="reference external" href="mailto:felipe&#46;balbi&#37;&#52;&#48;linux&#46;intel&#46;com">me</a> with <a class="reference external" href="mailto:linux-usb&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-usb</a> in Cc. If you want to be extra
sure that I&#8217;ll help you, write your subject line in the following
format:</p>
<blockquote>
<div><strong>[BUG REPORT] usb: dwc3: Bug while doing XYZ</strong></div></blockquote>
<p>On the email body, make sure to detail what you doing, which gadget
driver you were using, how to reproduce the problem, what SoC you&#8217;re
using, which OS (and its version) was running on the Host machine.</p>
<p>With all this information, we should be able to understand what&#8217;s
going on and be helpful to you.</p>
</div>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>First and foremost a disclaimer:</p>
<div class="highlight-none"><div class="highlight"><pre>DISCLAIMER: The information available on DebugFS and/or TraceFS can
change at any time at any Major Linux Kernel Release. If writing
scripts, do **NOT** assume information to be available in the
current format.
</pre></div>
</div>
<p>With that out of the way, let&#8217;s carry on.</p>
<p>If you&#8217;re willing to debug your own problem, you deserve a round of
applause :-)</p>
<p>Anyway, there isn&#8217;t much to say here other than Trace Events will be
really helpful in figuring out issues with DWC3. Also, access to
Synopsys Databook will be <strong>really</strong> valuable in this case.</p>
<p>A USB Sniffer can be helpful at times but it&#8217;s not entirely required,
there&#8217;s a lot that can be understood without looking at the wire.</p>
<p>Feel free to email <a class="reference external" href="mailto:felipe&#46;balbi&#37;&#52;&#48;linux&#46;intel&#46;com">me</a> and Cc <a class="reference external" href="mailto:linux-usb&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-usb</a> if you need any help.</p>
<div class="section" id="debugfs">
<h3><code class="docutils literal"><span class="pre">DebugFS</span></code><a class="headerlink" href="#debugfs" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">DebugFS</span></code> is very good for gathering snapshots of what&#8217;s going on
with DWC3 and/or any endpoint.</p>
<p>On DWC3&#8217;s <code class="docutils literal"><span class="pre">DebugFS</span></code> directory, you will find the following files and
directories:</p>
<p><code class="docutils literal"><span class="pre">ep[0..15]{in,out}/</span></code>
<code class="docutils literal"><span class="pre">link_state</span></code>
<code class="docutils literal"><span class="pre">regdump</span></code>
<code class="docutils literal"><span class="pre">testmode</span></code></p>
<div class="section" id="link-state">
<h4><code class="docutils literal"><span class="pre">link_state</span></code><a class="headerlink" href="#link-state" title="Permalink to this headline">¶</a></h4>
<p>When read, <code class="docutils literal"><span class="pre">link_state</span></code> will print out one of <code class="docutils literal"><span class="pre">U0</span></code>, <code class="docutils literal"><span class="pre">U1</span></code>,
<code class="docutils literal"><span class="pre">U2</span></code>, <code class="docutils literal"><span class="pre">U3</span></code>, <code class="docutils literal"><span class="pre">SS.Disabled</span></code>, <code class="docutils literal"><span class="pre">RX.Detect</span></code>, <code class="docutils literal"><span class="pre">SS.Inactive</span></code>,
<code class="docutils literal"><span class="pre">Polling</span></code>, <code class="docutils literal"><span class="pre">Recovery</span></code>, <code class="docutils literal"><span class="pre">Hot</span> <span class="pre">Reset</span></code>, <code class="docutils literal"><span class="pre">Compliance</span></code>,
<code class="docutils literal"><span class="pre">Loopback</span></code>, <code class="docutils literal"><span class="pre">Reset</span></code>, <code class="docutils literal"><span class="pre">Resume</span></code> or <code class="docutils literal"><span class="pre">UNKNOWN</span> <span class="pre">link</span> <span class="pre">state</span></code>.</p>
<p>This file can also be written to in order to force link to one of the
states above.</p>
</div>
<div class="section" id="regdump">
<h4><code class="docutils literal"><span class="pre">regdump</span></code><a class="headerlink" href="#regdump" title="Permalink to this headline">¶</a></h4>
<p>File name is self-explanatory. When read, <code class="docutils literal"><span class="pre">regdump</span></code> will print out a
register dump of DWC3. Note that this file can be grepped to find the
information you want.</p>
</div>
<div class="section" id="testmode">
<h4><code class="docutils literal"><span class="pre">testmode</span></code><a class="headerlink" href="#testmode" title="Permalink to this headline">¶</a></h4>
<p>When read, <code class="docutils literal"><span class="pre">testmode</span></code> will print out a name of one of the specified
USB 2.0 Testmodes (<code class="docutils literal"><span class="pre">test_j</span></code>, <code class="docutils literal"><span class="pre">test_k</span></code>, <code class="docutils literal"><span class="pre">test_se0_nak</span></code>,
<code class="docutils literal"><span class="pre">test_packet</span></code>, <code class="docutils literal"><span class="pre">test_force_enable</span></code>) or the string <code class="docutils literal"><span class="pre">no</span> <span class="pre">test</span></code> in
case no tests are currently being executed.</p>
<p>In order to start any of these test modes, the same strings can be
written to the file and DWC3 will enter the requested test mode.</p>
</div>
<div class="section" id="ep-0-15-in-out">
<h4><code class="docutils literal"><span class="pre">ep[0..15]{in,out}</span></code><a class="headerlink" href="#ep-0-15-in-out" title="Permalink to this headline">¶</a></h4>
<p>For each endpoint we expose one directory following the naming
convention <code class="docutils literal"><span class="pre">ep$num$dir</span></code> <em>(ep0in, ep0out, ep1in, ...)</em>. Inside each
of these directories you will find the following files:</p>
<p><code class="docutils literal"><span class="pre">descriptor_fetch_queue</span></code>
<code class="docutils literal"><span class="pre">event_queue</span></code>
<code class="docutils literal"><span class="pre">rx_fifo_queue</span></code>
<code class="docutils literal"><span class="pre">rx_info_queue</span></code>
<code class="docutils literal"><span class="pre">rx_request_queue</span></code>
<code class="docutils literal"><span class="pre">transfer_type</span></code>
<code class="docutils literal"><span class="pre">trb_ring</span></code>
<code class="docutils literal"><span class="pre">tx_fifo_queue</span></code>
<code class="docutils literal"><span class="pre">tx_request_queue</span></code></p>
<p>With access to Synopsys Databook, you can decode the information on
them.</p>
<div class="section" id="transfer-type">
<h5><code class="docutils literal"><span class="pre">transfer_type</span></code><a class="headerlink" href="#transfer-type" title="Permalink to this headline">¶</a></h5>
<p>When read, <code class="docutils literal"><span class="pre">transfer_type</span></code> will print out one of <code class="docutils literal"><span class="pre">control</span></code>,
<code class="docutils literal"><span class="pre">bulk</span></code>, <code class="docutils literal"><span class="pre">interrupt</span></code> or <code class="docutils literal"><span class="pre">isochronous</span></code> depending on what the
endpoint descriptor says. If the endpoint hasn&#8217;t been enabled yet, it
will print <code class="docutils literal"><span class="pre">--</span></code>.</p>
</div>
<div class="section" id="trb-ring">
<h5><code class="docutils literal"><span class="pre">trb_ring</span></code><a class="headerlink" href="#trb-ring" title="Permalink to this headline">¶</a></h5>
<p>When read, <code class="docutils literal"><span class="pre">trb_ring</span></code> will print out details about all TRBs on the
ring. It will also tell you where our enqueue and dequeue pointers are
located in the ring:</p>
<div class="highlight-sh"><div class="highlight"><pre>buffer_addr,size,type,ioc,isp_imi,csp,chn,lst,hwo
000000002c754000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c75c000,512,normal,1,0,1,0,0,1        D
0000000000000000,0,UNKNOWN,0,0,0,0,0,0       E
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
0000000000000000,0,UNKNOWN,0,0,0,0,0,0
00000000381ab000,0,link,0,0,0,0,0,1
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="trace-events">
<h3>Trace Events<a class="headerlink" href="#trace-events" title="Permalink to this headline">¶</a></h3>
<p>DWC3 also provides several trace events which help us gathering
information about the behavior of the driver during runtime.</p>
<p>In order to use these events, you must enable <code class="docutils literal"><span class="pre">CONFIG_FTRACE</span></code> in
your kernel config.</p>
<p>For details about how enable DWC3 events, see section <strong>Reporting
Bugs</strong>.</p>
<p>The following subsections will give details about each Event Class and
each Event defined by DWC3.</p>
<div class="section" id="mmio">
<h4>MMIO<a class="headerlink" href="#mmio" title="Permalink to this headline">¶</a></h4>
<p>It is sometimes useful to look at every MMIO access when looking for
bugs. Because of that, DWC3 offers two Trace Events (one for
dwc3_readl() and one for dwc3_writel()). <code class="docutils literal"><span class="pre">TP_printk</span></code> follows:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;addr %p value %08x&quot;, __entry-&gt;base + __entry-&gt;offset,
              __entry-&gt;value)
</pre></div>
</div>
</div>
<div class="section" id="interrupt-events">
<h4>Interrupt Events<a class="headerlink" href="#interrupt-events" title="Permalink to this headline">¶</a></h4>
<p>Every IRQ event can be logged and decoded into a human readable
string. Because every event will be different, we don&#8217;t give an
example other than the <code class="docutils literal"><span class="pre">TP_printk</span></code> format used:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;event (%08x): %s&quot;, __entry-&gt;event,
              dwc3_decode_event(__entry-&gt;event, __entry-&gt;ep0state))
</pre></div>
</div>
</div>
<div class="section" id="control-request">
<h4>Control Request<a class="headerlink" href="#control-request" title="Permalink to this headline">¶</a></h4>
<p>Every USB Control Request can be logged to the trace buffer. The
output format is:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;%s&quot;, dwc3_decode_ctrl(__entry-&gt;bRequestType,
                              __entry-&gt;bRequest, __entry-&gt;wValue,
                              __entry-&gt;wIndex, __entry-&gt;wLength)
)
</pre></div>
</div>
<p>Note that Standard Control Requests will be decoded into
human-readable strings with their respective arguments. Class and
Vendor requests will be printed out a sequence of 8 bytes in hex
format.</p>
</div>
<div class="section" id="lifetime-of-a-struct-usb-request">
<h4>Lifetime of a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">usb_request</span></code><a class="headerlink" href="#lifetime-of-a-struct-usb-request" title="Permalink to this headline">¶</a></h4>
<p>The entire lifetime of a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">usb_request</span></code> can be tracked on the
trace buffer. We have one event for each of allocation, free,
queueing, dequeueing, and giveback. Output format is:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;%s: req %p length %u/%u %s%s%s ==&gt; %d&quot;,
      __get_str(name), __entry-&gt;req, __entry-&gt;actual, __entry-&gt;length,
      __entry-&gt;zero ? &quot;Z&quot; : &quot;z&quot;,
      __entry-&gt;short_not_ok ? &quot;S&quot; : &quot;s&quot;,
      __entry-&gt;no_interrupt ? &quot;i&quot; : &quot;I&quot;,
      __entry-&gt;status
)
</pre></div>
</div>
</div>
<div class="section" id="generic-commands">
<h4>Generic Commands<a class="headerlink" href="#generic-commands" title="Permalink to this headline">¶</a></h4>
<p>We can log and decode every Generic Command with its completion
code. Format is:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;cmd &#39;%s&#39; [%x] param %08x --&gt; status: %s&quot;,
      dwc3_gadget_generic_cmd_string(__entry-&gt;cmd),
      __entry-&gt;cmd, __entry-&gt;param,
      dwc3_gadget_generic_cmd_status_string(__entry-&gt;status)
)
</pre></div>
</div>
</div>
<div class="section" id="endpoint-commands">
<h4>Endpoint Commands<a class="headerlink" href="#endpoint-commands" title="Permalink to this headline">¶</a></h4>
<p>Endpoints commands can also be logged together with completion
code. Format is:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;%s: cmd &#39;%s&#39; [%d] params %08x %08x %08x --&gt; status: %s&quot;,
      __get_str(name), dwc3_gadget_ep_cmd_string(__entry-&gt;cmd),
      __entry-&gt;cmd, __entry-&gt;param0,
      __entry-&gt;param1, __entry-&gt;param2,
      dwc3_ep_cmd_status_string(__entry-&gt;cmd_status)
)
</pre></div>
</div>
</div>
<div class="section" id="lifetime-of-a-trb">
<h4>Lifetime of a <code class="docutils literal"><span class="pre">TRB</span></code><a class="headerlink" href="#lifetime-of-a-trb" title="Permalink to this headline">¶</a></h4>
<p>A <code class="docutils literal"><span class="pre">TRB</span></code> Lifetime is simple. We are either preparing a <code class="docutils literal"><span class="pre">TRB</span></code> or
completing it. With these two events, we can see how a <code class="docutils literal"><span class="pre">TRB</span></code> changes
over time. Format is:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;%s: %d/%d trb %p buf %08x%08x size %s%d ctrl %08x (%c%c%c%c:%c%c:%s)&quot;,
      __get_str(name), __entry-&gt;queued, __entry-&gt;allocated,
      __entry-&gt;trb, __entry-&gt;bph, __entry-&gt;bpl,
      ({char *s;
      int pcm = ((__entry-&gt;size &gt;&gt; 24) &amp; 3) + 1;
      switch (__entry-&gt;type) {
      case USB_ENDPOINT_XFER_INT:
      case USB_ENDPOINT_XFER_ISOC:
              switch (pcm) {
              case 1:
                      s = &quot;1x &quot;;
                      break;
              case 2:
                      s = &quot;2x &quot;;
                      break;
              case 3:
                      s = &quot;3x &quot;;
                      break;
              }
      default:
              s = &quot;&quot;;
      } s; }),
      DWC3_TRB_SIZE_LENGTH(__entry-&gt;size), __entry-&gt;ctrl,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_HWO ? &#39;H&#39; : &#39;h&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_LST ? &#39;L&#39; : &#39;l&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_CHN ? &#39;C&#39; : &#39;c&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_CSP ? &#39;S&#39; : &#39;s&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_ISP_IMI ? &#39;S&#39; : &#39;s&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_IOC ? &#39;C&#39; : &#39;c&#39;,
    dwc3_trb_type_string(DWC3_TRBCTL_TYPE(__entry-&gt;ctrl))
)
</pre></div>
</div>
</div>
<div class="section" id="lifetime-of-an-endpoint">
<h4>Lifetime of an Endpoint<a class="headerlink" href="#lifetime-of-an-endpoint" title="Permalink to this headline">¶</a></h4>
<p>And endpoint&#8217;s lifetime is summarized with enable and disable
operations, both of which can be traced. Format is:</p>
<div class="highlight-none"><div class="highlight"><pre>TP_printk(&quot;%s: mps %d/%d streams %d burst %d ring %d/%d flags %c:%c%c%c%c%c:%c:%c&quot;,
      __get_str(name), __entry-&gt;maxpacket,
      __entry-&gt;maxpacket_limit, __entry-&gt;max_streams,
      __entry-&gt;maxburst, __entry-&gt;trb_enqueue,
      __entry-&gt;trb_dequeue,
      __entry-&gt;flags &amp; DWC3_EP_ENABLED ? &#39;E&#39; : &#39;e&#39;,
      __entry-&gt;flags &amp; DWC3_EP_STALL ? &#39;S&#39; : &#39;s&#39;,
      __entry-&gt;flags &amp; DWC3_EP_WEDGE ? &#39;W&#39; : &#39;w&#39;,
      __entry-&gt;flags &amp; DWC3_EP_TRANSFER_STARTED ? &#39;B&#39; : &#39;b&#39;,
      __entry-&gt;flags &amp; DWC3_EP_PENDING_REQUEST ? &#39;P&#39; : &#39;p&#39;,
      __entry-&gt;flags &amp; DWC3_EP_END_TRANSFER_PENDING ? &#39;E&#39; : &#39;e&#39;,
      __entry-&gt;direction ? &#39;&lt;&#39; : &#39;&gt;&#39;
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="structures-methods-and-definitions">
<h2>Structures, Methods and Definitions<a class="headerlink" href="#structures-methods-and-definitions" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.dwc3_event_buffer">
struct <code class="descname">dwc3_event_buffer</code><a class="headerlink" href="#c.dwc3_event_buffer" title="Permalink to this definition">¶</a></dt>
<dd><p>Software event buffer representation</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_event_buffer {
  void *buf;
  void *cache;
  unsigned length;
  unsigned int            lpos;
  unsigned int            count;
  unsigned int            flags;
#define DWC3_EVENT_PENDING      BIT(0);
  dma_addr_t dma;
  struct dwc3             *dwc;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">buf</span></code></dt>
<dd>_THE_ buffer</dd>
<dt><code class="docutils literal"><span class="pre">cache</span></code></dt>
<dd>The buffer cache used in the threaded interrupt</dd>
<dt><code class="docutils literal"><span class="pre">length</span></code></dt>
<dd>size of this buffer</dd>
<dt><code class="docutils literal"><span class="pre">lpos</span></code></dt>
<dd>event offset</dd>
<dt><code class="docutils literal"><span class="pre">count</span></code></dt>
<dd>cache of last read event count register</dd>
<dt><code class="docutils literal"><span class="pre">flags</span></code></dt>
<dd>flags related to this event buffer</dd>
<dt><code class="docutils literal"><span class="pre">dma</span></code></dt>
<dd>dma_addr_t</dd>
<dt><code class="docutils literal"><span class="pre">dwc</span></code></dt>
<dd>pointer to DWC controller</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_ep">
struct <code class="descname">dwc3_ep</code><a class="headerlink" href="#c.dwc3_ep" title="Permalink to this definition">¶</a></dt>
<dd><p>device side endpoint representation</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_ep {
  struct usb_ep           endpoint;
  struct list_head        pending_list;
  struct list_head        started_list;
  wait_queue_head_t wait_end_transfer;
  spinlock_t lock;
  void __iomem            *regs;
  struct dwc3_trb         *trb_pool;
  dma_addr_t trb_pool_dma;
  struct dwc3             *dwc;
  u32 saved_state;
  unsigned flags;
#define DWC3_EP_ENABLED         BIT(0);
#define DWC3_EP_STALL           BIT(1);
#define DWC3_EP_WEDGE           BIT(2);
#define DWC3_EP_TRANSFER_STARTED BIT(3);
#define DWC3_EP_PENDING_REQUEST BIT(5);
#define DWC3_EP_END_TRANSFER_PENDING    BIT(7);
#define DWC3_EP0_DIR_IN         BIT(31);
  u8 trb_enqueue;
  u8 trb_dequeue;
  u8 number;
  u8 type;
  u8 resource_index;
  u32 frame_number;
  u32 interval;
  char name[20];
  unsigned direction:1;
  unsigned stream_capable:1;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">endpoint</span></code></dt>
<dd>usb endpoint</dd>
<dt><code class="docutils literal"><span class="pre">pending_list</span></code></dt>
<dd>list of pending requests for this endpoint</dd>
<dt><code class="docutils literal"><span class="pre">started_list</span></code></dt>
<dd>list of started requests on this endpoint</dd>
<dt><code class="docutils literal"><span class="pre">wait_end_transfer</span></code></dt>
<dd>wait_queue_head_t for waiting on End Transfer complete</dd>
<dt><code class="docutils literal"><span class="pre">lock</span></code></dt>
<dd>spinlock for endpoint request queue traversal</dd>
<dt><code class="docutils literal"><span class="pre">regs</span></code></dt>
<dd>pointer to first endpoint register</dd>
<dt><code class="docutils literal"><span class="pre">trb_pool</span></code></dt>
<dd>array of transaction buffers</dd>
<dt><code class="docutils literal"><span class="pre">trb_pool_dma</span></code></dt>
<dd>dma address of <strong>trb_pool</strong></dd>
<dt><code class="docutils literal"><span class="pre">dwc</span></code></dt>
<dd>pointer to DWC controller</dd>
<dt><code class="docutils literal"><span class="pre">saved_state</span></code></dt>
<dd>ep state saved during hibernation</dd>
<dt><code class="docutils literal"><span class="pre">flags</span></code></dt>
<dd>endpoint flags (wedged, stalled, ...)</dd>
<dt><code class="docutils literal"><span class="pre">trb_enqueue</span></code></dt>
<dd>enqueue &#8216;pointer&#8217; into TRB array</dd>
<dt><code class="docutils literal"><span class="pre">trb_dequeue</span></code></dt>
<dd>dequeue &#8216;pointer&#8217; into TRB array</dd>
<dt><code class="docutils literal"><span class="pre">number</span></code></dt>
<dd>endpoint number (1 - 15)</dd>
<dt><code class="docutils literal"><span class="pre">type</span></code></dt>
<dd>set to bmAttributes &amp; USB_ENDPOINT_XFERTYPE_MASK</dd>
<dt><code class="docutils literal"><span class="pre">resource_index</span></code></dt>
<dd>Resource transfer index</dd>
<dt><code class="docutils literal"><span class="pre">frame_number</span></code></dt>
<dd>set to the frame number we want this transfer to start (ISOC)</dd>
<dt><code class="docutils literal"><span class="pre">interval</span></code></dt>
<dd>the interval on which the ISOC transfer is started</dd>
<dt><code class="docutils literal"><span class="pre">name</span></code></dt>
<dd>a human readable name e.g. ep1out-bulk</dd>
<dt><code class="docutils literal"><span class="pre">direction</span></code></dt>
<dd>true for TX, false for RX</dd>
<dt><code class="docutils literal"><span class="pre">stream_capable</span></code></dt>
<dd>true when streams are enabled</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_trb">
struct <code class="descname">dwc3_trb</code><a class="headerlink" href="#c.dwc3_trb" title="Permalink to this definition">¶</a></dt>
<dd><p>transfer request block (hw format)</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_trb {
  u32 bpl;
  u32 bph;
  u32 size;
  u32 ctrl;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">bpl</span></code></dt>
<dd>DW0-3</dd>
<dt><code class="docutils literal"><span class="pre">bph</span></code></dt>
<dd>DW4-7</dd>
<dt><code class="docutils literal"><span class="pre">size</span></code></dt>
<dd>DW8-B</dd>
<dt><code class="docutils literal"><span class="pre">ctrl</span></code></dt>
<dd>DWC-F</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_hwparams">
struct <code class="descname">dwc3_hwparams</code><a class="headerlink" href="#c.dwc3_hwparams" title="Permalink to this definition">¶</a></dt>
<dd><p>copy of HWPARAMS registers</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_hwparams {
  u32 hwparams0;
  u32 hwparams1;
  u32 hwparams2;
  u32 hwparams3;
  u32 hwparams4;
  u32 hwparams5;
  u32 hwparams6;
  u32 hwparams7;
  u32 hwparams8;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">hwparams0</span></code></dt>
<dd>GHWPARAMS0</dd>
<dt><code class="docutils literal"><span class="pre">hwparams1</span></code></dt>
<dd>GHWPARAMS1</dd>
<dt><code class="docutils literal"><span class="pre">hwparams2</span></code></dt>
<dd>GHWPARAMS2</dd>
<dt><code class="docutils literal"><span class="pre">hwparams3</span></code></dt>
<dd>GHWPARAMS3</dd>
<dt><code class="docutils literal"><span class="pre">hwparams4</span></code></dt>
<dd>GHWPARAMS4</dd>
<dt><code class="docutils literal"><span class="pre">hwparams5</span></code></dt>
<dd>GHWPARAMS5</dd>
<dt><code class="docutils literal"><span class="pre">hwparams6</span></code></dt>
<dd>GHWPARAMS6</dd>
<dt><code class="docutils literal"><span class="pre">hwparams7</span></code></dt>
<dd>GHWPARAMS7</dd>
<dt><code class="docutils literal"><span class="pre">hwparams8</span></code></dt>
<dd>GHWPARAMS8</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_request">
struct <code class="descname">dwc3_request</code><a class="headerlink" href="#c.dwc3_request" title="Permalink to this definition">¶</a></dt>
<dd><p>representation of a transfer request</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_request {
  struct usb_request      request;
  struct list_head        list;
  struct dwc3_ep          *dep;
  struct scatterlist      *sg;
  struct scatterlist      *start_sg;
  unsigned num_pending_sgs;
  unsigned int            num_queued_sgs;
  u8 first_trb_index;
  unsigned remaining;
  u8 epnum;
  struct dwc3_trb         *trb;
  dma_addr_t trb_dma;
  struct timer_list       stream_timeout_timer;
  unsigned unaligned:1;
  unsigned direction:1;
  unsigned mapped:1;
  unsigned started:1;
  unsigned zero:1;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">request</span></code></dt>
<dd>struct usb_request to be transferred</dd>
<dt><code class="docutils literal"><span class="pre">list</span></code></dt>
<dd>a list_head used for request queueing</dd>
<dt><code class="docutils literal"><span class="pre">dep</span></code></dt>
<dd>struct dwc3_ep owning this request</dd>
<dt><code class="docutils literal"><span class="pre">sg</span></code></dt>
<dd>pointer to first incomplete sg</dd>
<dt><code class="docutils literal"><span class="pre">start_sg</span></code></dt>
<dd>pointer to the sg which should be queued next</dd>
<dt><code class="docutils literal"><span class="pre">num_pending_sgs</span></code></dt>
<dd>counter to pending sgs</dd>
<dt><code class="docutils literal"><span class="pre">num_queued_sgs</span></code></dt>
<dd>counter to the number of sgs which already got queued</dd>
<dt><code class="docutils literal"><span class="pre">remaining</span></code></dt>
<dd>amount of data remaining</dd>
<dt><code class="docutils literal"><span class="pre">epnum</span></code></dt>
<dd>endpoint number to which this request refers</dd>
<dt><code class="docutils literal"><span class="pre">trb</span></code></dt>
<dd>pointer to struct dwc3_trb</dd>
<dt><code class="docutils literal"><span class="pre">trb_dma</span></code></dt>
<dd>DMA address of <strong>trb</strong></dd>
<dt><code class="docutils literal"><span class="pre">stream_timeout_timer</span></code></dt>
<dd>Some endpoints may go out of sync with host and
enter into deadlock. For example, stream capable endpoints may enter
into deadlock where the host waits on gadget to issue ERDY and gadget
waits for host to issue prime transaction. To avoid such deadlock this
timer is used.</dd>
<dt><code class="docutils literal"><span class="pre">unaligned</span></code></dt>
<dd>true for OUT endpoints with length not divisible by maxp</dd>
<dt><code class="docutils literal"><span class="pre">direction</span></code></dt>
<dd>IN or OUT direction flag</dd>
<dt><code class="docutils literal"><span class="pre">mapped</span></code></dt>
<dd>true when request has been dma-mapped</dd>
<dt><code class="docutils literal"><span class="pre">started</span></code></dt>
<dd>request is started</dd>
<dt><code class="docutils literal"><span class="pre">zero</span></code></dt>
<dd>wants a ZLP</dd>
</dl>
<dl class="type">
<dt id="c.dwc3">
struct <code class="descname">dwc3</code><a class="headerlink" href="#c.dwc3" title="Permalink to this definition">¶</a></dt>
<dd><p>representation of our controller</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3 {
  struct work_struct      drd_work;
  struct dwc3_trb         *ep0_trb;
  void *bounce;
  void *scratchbuf;
  u8 *setup_buf;
  dma_addr_t ep0_trb_addr;
  dma_addr_t bounce_addr;
  dma_addr_t scratch_addr;
  struct dwc3_request     ep0_usb_req;
  struct completion       ep0_in_setup;
  spinlock_t lock;
  struct device           *dev;
  struct device           *sysdev;
  struct platform_device  *xhci;
  struct resource         xhci_resources[DWC3_XHCI_RESOURCES_NUM];
  struct dwc3_event_buffer *ev_buf;
  struct dwc3_ep          *eps[DWC3_ENDPOINTS_NUM];
  struct usb_gadget       gadget;
  struct usb_gadget_driver *gadget_driver;
  struct clk_bulk_data    *clks;
  int num_clks;
  struct reset_control    *reset;
  struct dwc3_otg         *otg;
  struct usb_phy          *usb2_phy;
  struct usb_phy          *usb3_phy;
  struct phy              *usb2_generic_phy;
  struct phy              *usb3_generic_phy;
  bool phys_ready;
  struct ulpi             *ulpi;
  bool ulpi_ready;
  void __iomem            *regs;
  size_t regs_size;
  enum usb_dr_mode        dr_mode;
  u32 current_dr_role;
  u32 desired_dr_role;
  struct extcon_dev       *edev;
  struct notifier_block   edev_nb;
  enum usb_phy_interface  hsphy_mode;
  u32 fladj;
  bool refclk_fladj;
  u32 irq_gadget;
  u32 otg_irq;
  u32 current_otg_role;
  u32 desired_otg_role;
  bool otg_restart_host;
  u32 nr_scratch;
  u32 u1u2;
  u32 maximum_speed;
  u32 revision;
#define DWC3_REVISION_173A      0x5533173a;
#define DWC3_REVISION_175A      0x5533175a;
#define DWC3_REVISION_180A      0x5533180a;
#define DWC3_REVISION_183A      0x5533183a;
#define DWC3_REVISION_185A      0x5533185a;
#define DWC3_REVISION_187A      0x5533187a;
#define DWC3_REVISION_188A      0x5533188a;
#define DWC3_REVISION_190A      0x5533190a;
#define DWC3_REVISION_194A      0x5533194a;
#define DWC3_REVISION_200A      0x5533200a;
#define DWC3_REVISION_202A      0x5533202a;
#define DWC3_REVISION_210A      0x5533210a;
#define DWC3_REVISION_220A      0x5533220a;
#define DWC3_REVISION_230A      0x5533230a;
#define DWC3_REVISION_240A      0x5533240a;
#define DWC3_REVISION_250A      0x5533250a;
#define DWC3_REVISION_260A      0x5533260a;
#define DWC3_REVISION_270A      0x5533270a;
#define DWC3_REVISION_280A      0x5533280a;
#define DWC3_REVISION_290A      0x5533290a;
#define DWC3_REVISION_300A      0x5533300a;
#define DWC3_REVISION_310A      0x5533310a;
#define DWC3_REVISION_IS_DWC31          0x80000000;
#define DWC3_USB31_REVISION_110A        (0x3131302a | DWC3_REVISION_IS_DWC31);
#define DWC3_USB31_REVISION_120A        (0x3132302a | DWC3_REVISION_IS_DWC31);
  enum dwc3_ep0_next      ep0_next_event;
  enum dwc3_ep0_state     ep0state;
  enum dwc3_link_state    link_state;
  u16 u2sel;
  u16 u2pel;
  u8 u1sel;
  u8 u1pel;
  u8 speed;
  u8 num_eps;
  struct dwc3_hwparams    hwparams;
  struct dentry           *root;
  struct debugfs_regset32 *regset;
  u8 test_mode;
  u8 test_mode_nr;
  u8 lpm_nyet_threshold;
  u8 hird_threshold;
  u8 rx_thr_num_pkt_prd;
  u8 rx_max_burst_prd;
  u8 tx_thr_num_pkt_prd;
  u8 tx_max_burst_prd;
  const char              *hsphy_interface;
  unsigned connected:1;
  unsigned delayed_status:1;
  unsigned ep0_bounced:1;
  unsigned ep0_expect_in:1;
  unsigned has_hibernation:1;
  unsigned sysdev_is_parent:1;
  unsigned has_lpm_erratum:1;
  unsigned is_utmi_l1_suspend:1;
  unsigned is_fpga:1;
  unsigned pending_events:1;
  unsigned pullups_connected:1;
  unsigned setup_packet_pending:1;
  unsigned three_stage_setup:1;
  unsigned usb3_lpm_capable:1;
  unsigned remote_wakeup:1;
  unsigned disable_scramble_quirk:1;
  unsigned u2exit_lfps_quirk:1;
  unsigned u2ss_inp3_quirk:1;
  unsigned req_p1p2p3_quirk:1;
  unsigned del_p1p2p3_quirk:1;
  unsigned del_phy_power_chg_quirk:1;
  unsigned lfps_filter_quirk:1;
  unsigned rx_detect_poll_quirk:1;
  unsigned dis_u3_susphy_quirk:1;
  unsigned dis_u2_susphy_quirk:1;
  unsigned dis_enblslpm_quirk:1;
  unsigned dis_rxdet_inp3_quirk:1;
  unsigned dis_u2_freeclk_exists_quirk:1;
  unsigned dis_del_phy_power_chg_quirk:1;
  unsigned enable_guctl1_resume_quirk:1;
  unsigned enable_guctl1_ipd_quirk:1;
  unsigned dis_tx_ipgap_linecheck_quirk:1;
  unsigned tx_de_emphasis_quirk:1;
  unsigned tx_de_emphasis:2;
  unsigned is_hibernated:1;
  unsigned dis_metastability_quirk:1;
  u16 imod_interval;
  bool is_d3;
  u32 *saved_regs;
  u32 irq_wakeup;
  bool force_hiber_wake;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">drd_work</span></code></dt>
<dd>workqueue used for role swapping</dd>
<dt><code class="docutils literal"><span class="pre">ep0_trb</span></code></dt>
<dd>trb which is used for the ctrl_req</dd>
<dt><code class="docutils literal"><span class="pre">bounce</span></code></dt>
<dd>address of bounce buffer</dd>
<dt><code class="docutils literal"><span class="pre">scratchbuf</span></code></dt>
<dd>address of scratch buffer</dd>
<dt><code class="docutils literal"><span class="pre">setup_buf</span></code></dt>
<dd>used while precessing STD USB requests</dd>
<dt><code class="docutils literal"><span class="pre">ep0_trb_addr</span></code></dt>
<dd>dma address of <strong>ep0_trb</strong></dd>
<dt><code class="docutils literal"><span class="pre">bounce_addr</span></code></dt>
<dd>dma address of <strong>bounce</strong></dd>
<dt><code class="docutils literal"><span class="pre">scratch_addr</span></code></dt>
<dd>dma address of scratchbuf</dd>
<dt><code class="docutils literal"><span class="pre">ep0_usb_req</span></code></dt>
<dd>dummy req used while handling STD USB requests</dd>
<dt><code class="docutils literal"><span class="pre">ep0_in_setup</span></code></dt>
<dd>one control transfer is completed and enter setup phase</dd>
<dt><code class="docutils literal"><span class="pre">lock</span></code></dt>
<dd>for synchronizing</dd>
<dt><code class="docutils literal"><span class="pre">dev</span></code></dt>
<dd>pointer to our struct device</dd>
<dt><code class="docutils literal"><span class="pre">sysdev</span></code></dt>
<dd>pointer to the DMA-capable device</dd>
<dt><code class="docutils literal"><span class="pre">xhci</span></code></dt>
<dd>pointer to our xHCI child</dd>
<dt><code class="docutils literal"><span class="pre">xhci_resources</span></code></dt>
<dd>struct resources for our <strong>xhci</strong> child</dd>
<dt><code class="docutils literal"><span class="pre">ev_buf</span></code></dt>
<dd>struct dwc3_event_buffer pointer</dd>
<dt><code class="docutils literal"><span class="pre">eps</span></code></dt>
<dd>endpoint array</dd>
<dt><code class="docutils literal"><span class="pre">gadget</span></code></dt>
<dd>device side representation of the peripheral controller</dd>
<dt><code class="docutils literal"><span class="pre">gadget_driver</span></code></dt>
<dd>pointer to the gadget driver</dd>
<dt><code class="docutils literal"><span class="pre">clks</span></code></dt>
<dd>array of clocks</dd>
<dt><code class="docutils literal"><span class="pre">num_clks</span></code></dt>
<dd>number of clocks</dd>
<dt><code class="docutils literal"><span class="pre">reset</span></code></dt>
<dd>reset control</dd>
<dt><code class="docutils literal"><span class="pre">otg</span></code></dt>
<dd>pointer to the dwc3_otg structure</dd>
<dt><code class="docutils literal"><span class="pre">usb2_phy</span></code></dt>
<dd>pointer to USB2 PHY</dd>
<dt><code class="docutils literal"><span class="pre">usb3_phy</span></code></dt>
<dd>pointer to USB3 PHY</dd>
<dt><code class="docutils literal"><span class="pre">usb2_generic_phy</span></code></dt>
<dd>pointer to USB2 PHY</dd>
<dt><code class="docutils literal"><span class="pre">usb3_generic_phy</span></code></dt>
<dd>pointer to USB3 PHY</dd>
<dt><code class="docutils literal"><span class="pre">phys_ready</span></code></dt>
<dd>flag to indicate that PHYs are ready</dd>
<dt><code class="docutils literal"><span class="pre">ulpi</span></code></dt>
<dd>pointer to ulpi interface</dd>
<dt><code class="docutils literal"><span class="pre">ulpi_ready</span></code></dt>
<dd>flag to indicate that ULPI is initialized</dd>
<dt><code class="docutils literal"><span class="pre">regs</span></code></dt>
<dd>base address for our registers</dd>
<dt><code class="docutils literal"><span class="pre">regs_size</span></code></dt>
<dd>address space size</dd>
<dt><code class="docutils literal"><span class="pre">dr_mode</span></code></dt>
<dd>requested mode of operation</dd>
<dt><code class="docutils literal"><span class="pre">current_dr_role</span></code></dt>
<dd>current role of operation when in dual-role mode</dd>
<dt><code class="docutils literal"><span class="pre">desired_dr_role</span></code></dt>
<dd>desired role of operation when in dual-role mode</dd>
<dt><code class="docutils literal"><span class="pre">edev</span></code></dt>
<dd>extcon handle</dd>
<dt><code class="docutils literal"><span class="pre">edev_nb</span></code></dt>
<dd>extcon notifier</dd>
<dt><code class="docutils literal"><span class="pre">hsphy_mode</span></code></dt>
<dd>UTMI phy mode, one of following:
- USBPHY_INTERFACE_MODE_UTMI
- USBPHY_INTERFACE_MODE_UTMIW</dd>
<dt><code class="docutils literal"><span class="pre">fladj</span></code></dt>
<dd>frame length adjustment</dd>
<dt><code class="docutils literal"><span class="pre">refclk_fladj</span></code></dt>
<dd>boolean to update GFLADJ_REFCLK_FLADJ field also</dd>
<dt><code class="docutils literal"><span class="pre">irq_gadget</span></code></dt>
<dd>peripheral controller&#8217;s IRQ number</dd>
<dt><code class="docutils literal"><span class="pre">otg_irq</span></code></dt>
<dd>IRQ number for OTG IRQs</dd>
<dt><code class="docutils literal"><span class="pre">current_otg_role</span></code></dt>
<dd>current role of operation while using the OTG block</dd>
<dt><code class="docutils literal"><span class="pre">desired_otg_role</span></code></dt>
<dd>desired role of operation while using the OTG block</dd>
<dt><code class="docutils literal"><span class="pre">otg_restart_host</span></code></dt>
<dd>flag that OTG controller needs to restart host</dd>
<dt><code class="docutils literal"><span class="pre">nr_scratch</span></code></dt>
<dd>number of scratch buffers</dd>
<dt><code class="docutils literal"><span class="pre">u1u2</span></code></dt>
<dd>only used on revisions &lt;1.83a for workaround</dd>
<dt><code class="docutils literal"><span class="pre">maximum_speed</span></code></dt>
<dd>maximum speed requested (mainly for testing purposes)</dd>
<dt><code class="docutils literal"><span class="pre">revision</span></code></dt>
<dd>revision register contents</dd>
<dt><code class="docutils literal"><span class="pre">ep0_next_event</span></code></dt>
<dd>hold the next expected event</dd>
<dt><code class="docutils literal"><span class="pre">ep0state</span></code></dt>
<dd>state of endpoint zero</dd>
<dt><code class="docutils literal"><span class="pre">link_state</span></code></dt>
<dd>link state</dd>
<dt><code class="docutils literal"><span class="pre">u2sel</span></code></dt>
<dd>parameter from Set SEL request.</dd>
<dt><code class="docutils literal"><span class="pre">u2pel</span></code></dt>
<dd>parameter from Set SEL request.</dd>
<dt><code class="docutils literal"><span class="pre">u1sel</span></code></dt>
<dd>parameter from Set SEL request.</dd>
<dt><code class="docutils literal"><span class="pre">u1pel</span></code></dt>
<dd>parameter from Set SEL request.</dd>
<dt><code class="docutils literal"><span class="pre">speed</span></code></dt>
<dd>device speed (super, high, full, low)</dd>
<dt><code class="docutils literal"><span class="pre">num_eps</span></code></dt>
<dd>number of endpoints</dd>
<dt><code class="docutils literal"><span class="pre">hwparams</span></code></dt>
<dd>copy of hwparams registers</dd>
<dt><code class="docutils literal"><span class="pre">root</span></code></dt>
<dd>debugfs root folder pointer</dd>
<dt><code class="docutils literal"><span class="pre">regset</span></code></dt>
<dd>debugfs pointer to regdump file</dd>
<dt><code class="docutils literal"><span class="pre">test_mode</span></code></dt>
<dd>true when we&#8217;re entering a USB test mode</dd>
<dt><code class="docutils literal"><span class="pre">test_mode_nr</span></code></dt>
<dd>test feature selector</dd>
<dt><code class="docutils literal"><span class="pre">lpm_nyet_threshold</span></code></dt>
<dd>LPM NYET response threshold</dd>
<dt><code class="docutils literal"><span class="pre">hird_threshold</span></code></dt>
<dd>HIRD threshold</dd>
<dt><code class="docutils literal"><span class="pre">rx_thr_num_pkt_prd</span></code></dt>
<dd>periodic ESS receive packet count</dd>
<dt><code class="docutils literal"><span class="pre">rx_max_burst_prd</span></code></dt>
<dd>max periodic ESS receive burst size</dd>
<dt><code class="docutils literal"><span class="pre">tx_thr_num_pkt_prd</span></code></dt>
<dd>periodic ESS transmit packet count</dd>
<dt><code class="docutils literal"><span class="pre">tx_max_burst_prd</span></code></dt>
<dd>max periodic ESS transmit burst size</dd>
<dt><code class="docutils literal"><span class="pre">hsphy_interface</span></code></dt>
<dd>&#8220;utmi&#8221; or &#8220;ulpi&#8221;</dd>
<dt><code class="docutils literal"><span class="pre">connected</span></code></dt>
<dd>true when we&#8217;re connected to a host, false otherwise</dd>
<dt><code class="docutils literal"><span class="pre">delayed_status</span></code></dt>
<dd>true when gadget driver asks for delayed status</dd>
<dt><code class="docutils literal"><span class="pre">ep0_bounced</span></code></dt>
<dd>true when we used bounce buffer</dd>
<dt><code class="docutils literal"><span class="pre">ep0_expect_in</span></code></dt>
<dd>true when we expect a DATA IN transfer</dd>
<dt><code class="docutils literal"><span class="pre">has_hibernation</span></code></dt>
<dd>true when dwc3 was configured with Hibernation</dd>
<dt><code class="docutils literal"><span class="pre">sysdev_is_parent</span></code></dt>
<dd>true when dwc3 device has a parent driver</dd>
<dt><code class="docutils literal"><span class="pre">has_lpm_erratum</span></code></dt>
<dd>true when core was configured with LPM Erratum. Note that
there&#8217;s now way for software to detect this in runtime.</dd>
<dt><code class="docutils literal"><span class="pre">is_utmi_l1_suspend</span></code></dt>
<dd>the core asserts output signal
0       - utmi_sleep_n
1       - utmi_l1_suspend_n</dd>
<dt><code class="docutils literal"><span class="pre">is_fpga</span></code></dt>
<dd>true when we are using the FPGA board</dd>
<dt><code class="docutils literal"><span class="pre">pending_events</span></code></dt>
<dd>true when we have pending IRQs to be handled</dd>
<dt><code class="docutils literal"><span class="pre">pullups_connected</span></code></dt>
<dd>true when Run/Stop bit is set</dd>
<dt><code class="docutils literal"><span class="pre">setup_packet_pending</span></code></dt>
<dd>true when there&#8217;s a Setup Packet in FIFO. Workaround</dd>
<dt><code class="docutils literal"><span class="pre">three_stage_setup</span></code></dt>
<dd>set if we perform a three phase setup</dd>
<dt><code class="docutils literal"><span class="pre">usb3_lpm_capable</span></code></dt>
<dd>set if hadrware supports Link Power Management</dd>
<dt><code class="docutils literal"><span class="pre">remote_wakeup</span></code></dt>
<dd>set if host supports Remote Wakeup from Peripheral</dd>
<dt><code class="docutils literal"><span class="pre">disable_scramble_quirk</span></code></dt>
<dd>set if we enable the disable scramble quirk</dd>
<dt><code class="docutils literal"><span class="pre">u2exit_lfps_quirk</span></code></dt>
<dd>set if we enable u2exit lfps quirk</dd>
<dt><code class="docutils literal"><span class="pre">u2ss_inp3_quirk</span></code></dt>
<dd>set if we enable P3 OK for U2/SS Inactive quirk</dd>
<dt><code class="docutils literal"><span class="pre">req_p1p2p3_quirk</span></code></dt>
<dd>set if we enable request p1p2p3 quirk</dd>
<dt><code class="docutils literal"><span class="pre">del_p1p2p3_quirk</span></code></dt>
<dd>set if we enable delay p1p2p3 quirk</dd>
<dt><code class="docutils literal"><span class="pre">del_phy_power_chg_quirk</span></code></dt>
<dd>set if we enable delay phy power change quirk</dd>
<dt><code class="docutils literal"><span class="pre">lfps_filter_quirk</span></code></dt>
<dd>set if we enable LFPS filter quirk</dd>
<dt><code class="docutils literal"><span class="pre">rx_detect_poll_quirk</span></code></dt>
<dd>set if we enable rx_detect to polling lfps quirk</dd>
<dt><code class="docutils literal"><span class="pre">dis_u3_susphy_quirk</span></code></dt>
<dd>set if we disable usb3 suspend phy</dd>
<dt><code class="docutils literal"><span class="pre">dis_u2_susphy_quirk</span></code></dt>
<dd>set if we disable usb2 suspend phy</dd>
<dt><code class="docutils literal"><span class="pre">dis_enblslpm_quirk</span></code></dt>
<dd>set if we clear enblslpm in GUSB2PHYCFG,
disabling the suspend signal to the PHY.</dd>
<dt><code class="docutils literal"><span class="pre">dis_rxdet_inp3_quirk</span></code></dt>
<dd>set if we disable Rx.Detect in P3</dd>
<dt><code class="docutils literal"><span class="pre">dis_u2_freeclk_exists_quirk</span></code></dt>
<dd>set if we clear u2_freeclk_exists
in GUSB2PHYCFG, specify that USB2 PHY doesn&#8217;t
provide a free-running PHY clock.</dd>
<dt><code class="docutils literal"><span class="pre">dis_del_phy_power_chg_quirk</span></code></dt>
<dd>set if we disable delay phy power
change quirk.</dd>
<dt><code class="docutils literal"><span class="pre">enable_guctl1_resume_quirk</span></code></dt>
<dd>Set if we enable quirk for fixing improper crc
generation after resume from suspend.</dd>
<dt><code class="docutils literal"><span class="pre">enable_guctl1_ipd_quirk</span></code></dt>
<dd>set if we enable quirk for reducing timing of inter
packet delay(ipd).</dd>
<dt><code class="docutils literal"><span class="pre">dis_tx_ipgap_linecheck_quirk</span></code></dt>
<dd>set if we disable u2mac linestate
check during HS transmit.</dd>
<dt><code class="docutils literal"><span class="pre">tx_de_emphasis_quirk</span></code></dt>
<dd>set if we enable Tx de-emphasis quirk</dd>
<dt><code class="docutils literal"><span class="pre">tx_de_emphasis</span></code></dt>
<dd>Tx de-emphasis value
0       - -6dB de-emphasis
1       - -3.5dB de-emphasis
2       - No de-emphasis
3       - Reserved</dd>
<dt><code class="docutils literal"><span class="pre">is_hibernated</span></code></dt>
<dd>true when dwc3 is hibernated; abort processing events</dd>
<dt><code class="docutils literal"><span class="pre">dis_metastability_quirk</span></code></dt>
<dd>set to disable metastability quirk.</dd>
<dt><code class="docutils literal"><span class="pre">imod_interval</span></code></dt>
<dd>set the interrupt moderation interval in 250ns
increments or 0 to disable.</dd>
<dt><code class="docutils literal"><span class="pre">is_d3</span></code></dt>
<dd>set if the controller is in d3 state</dd>
<dt><code class="docutils literal"><span class="pre">saved_regs</span></code></dt>
<dd>registers to be saved/restored during hibernation/wakeup events</dd>
<dt><code class="docutils literal"><span class="pre">irq_wakeup</span></code></dt>
<dd>wakeup IRQ number, triggered when host asks to wakeup from
hibernation</dd>
<dt><code class="docutils literal"><span class="pre">force_hiber_wake</span></code></dt>
<dd>flag set when the gadget driver is forcefully triggering</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_event_depevt">
struct <code class="descname">dwc3_event_depevt</code><a class="headerlink" href="#c.dwc3_event_depevt" title="Permalink to this definition">¶</a></dt>
<dd><p>Device Endpoint Events</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_event_depevt {
  u32 one_bit:1;
  u32 endpoint_number:5;
  u32 endpoint_event:4;
  u32 reserved11_10:2;
  u32 status:4;
#define DEPEVT_STATUS_TRANSFER_ACTIVE   BIT(3);
#define DEPEVT_STATUS_BUSERR    BIT(0);
#define DEPEVT_STATUS_SHORT     BIT(1);
#define DEPEVT_STATUS_IOC       BIT(2);
#define DEPEVT_STATUS_LST       BIT(3) ;
#define DEPEVT_STATUS_MISSED_ISOC BIT(3) ;
#define DEPEVT_STREAMEVT_FOUND          1;
#define DEPEVT_STREAMEVT_NOTFOUND       2;
#define DEPEVT_STATUS_CONTROL_DATA      1;
#define DEPEVT_STATUS_CONTROL_STATUS    2;
#define DEPEVT_STATUS_CONTROL_PHASE(n)  ((n) &amp; 3);
#define DEPEVT_TRANSFER_NO_RESOURCE     1;
#define DEPEVT_TRANSFER_BUS_EXPIRY      2;
  u32 parameters:16;
#define DEPEVT_PARAMETER_CMD(n) (((n) &amp; (0xf &lt;&lt; 8)) &gt;&gt; 8);
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">one_bit</span></code></dt>
<dd>indicates this is an endpoint event (not used)</dd>
<dt><code class="docutils literal"><span class="pre">endpoint_number</span></code></dt>
<dd>number of the endpoint</dd>
<dt><code class="docutils literal"><span class="pre">endpoint_event</span></code></dt>
<dd>The event we have:
0x00    - Reserved
0x01    - XferComplete
0x02    - XferInProgress
0x03    - XferNotReady
0x04    - RxTxFifoEvt (IN-&gt;Underrun, OUT-&gt;Overrun)
0x05    - Reserved
0x06    - StreamEvt
0x07    - EPCmdCmplt</dd>
<dt><code class="docutils literal"><span class="pre">reserved11_10</span></code></dt>
<dd>Reserved, don&#8217;t use.</dd>
<dt><code class="docutils literal"><span class="pre">status</span></code></dt>
<dd>Indicates the status of the event. Refer to databook for
more information.</dd>
<dt><code class="docutils literal"><span class="pre">parameters</span></code></dt>
<dd>Parameters of the current event. Refer to databook for
more information.</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_event_devt">
struct <code class="descname">dwc3_event_devt</code><a class="headerlink" href="#c.dwc3_event_devt" title="Permalink to this definition">¶</a></dt>
<dd><p>Device Events</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_event_devt {
  u32 one_bit:1;
  u32 device_event:7;
  u32 type:4;
  u32 reserved15_12:4;
  u32 event_info:9;
  u32 reserved31_25:7;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">one_bit</span></code></dt>
<dd>indicates this is a non-endpoint event (not used)</dd>
<dt><code class="docutils literal"><span class="pre">device_event</span></code></dt>
<dd>indicates it&#8217;s a device event. Should read as 0x00</dd>
<dt><code class="docutils literal"><span class="pre">type</span></code></dt>
<dd>indicates the type of device event.
0       - DisconnEvt
1       - USBRst
2       - ConnectDone
3       - ULStChng
4       - WkUpEvt
5       - Reserved
6       - EOPF
7       - SOF
8       - Reserved
9       - ErrticErr
10      - CmdCmplt
11      - EvntOverflow
12      - VndrDevTstRcved</dd>
<dt><code class="docutils literal"><span class="pre">reserved15_12</span></code></dt>
<dd>Reserved, not used</dd>
<dt><code class="docutils literal"><span class="pre">event_info</span></code></dt>
<dd>Information about this event</dd>
<dt><code class="docutils literal"><span class="pre">reserved31_25</span></code></dt>
<dd>Reserved, not used</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_event_gevt">
struct <code class="descname">dwc3_event_gevt</code><a class="headerlink" href="#c.dwc3_event_gevt" title="Permalink to this definition">¶</a></dt>
<dd><p>Other Core Events</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_event_gevt {
  u32 one_bit:1;
  u32 device_event:7;
  u32 phy_port_number:4;
  u32 reserved31_12:20;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">one_bit</span></code></dt>
<dd>indicates this is a non-endpoint event (not used)</dd>
<dt><code class="docutils literal"><span class="pre">device_event</span></code></dt>
<dd>indicates it&#8217;s (0x03) Carkit or (0x04) I2C event.</dd>
<dt><code class="docutils literal"><span class="pre">phy_port_number</span></code></dt>
<dd>self-explanatory</dd>
<dt><code class="docutils literal"><span class="pre">reserved31_12</span></code></dt>
<dd>Reserved, not used.</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_event">
union <code class="descname">dwc3_event</code><a class="headerlink" href="#c.dwc3_event" title="Permalink to this definition">¶</a></dt>
<dd><p>representation of Event Buffer contents</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>union dwc3_event {
  u32 raw;
  struct dwc3_event_type          type;
  struct dwc3_event_depevt        depevt;
  struct dwc3_event_devt          devt;
  struct dwc3_event_gevt          gevt;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">raw</span></code></dt>
<dd>raw 32-bit event</dd>
<dt><code class="docutils literal"><span class="pre">type</span></code></dt>
<dd>the type of the event</dd>
<dt><code class="docutils literal"><span class="pre">depevt</span></code></dt>
<dd>Device Endpoint Event</dd>
<dt><code class="docutils literal"><span class="pre">devt</span></code></dt>
<dd>Device Event</dd>
<dt><code class="docutils literal"><span class="pre">gevt</span></code></dt>
<dd>Global Event</dd>
</dl>
<dl class="type">
<dt id="c.dwc3_gadget_ep_cmd_params">
struct <code class="descname">dwc3_gadget_ep_cmd_params</code><a class="headerlink" href="#c.dwc3_gadget_ep_cmd_params" title="Permalink to this definition">¶</a></dt>
<dd><p>representation of endpoint command parameters</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre>struct dwc3_gadget_ep_cmd_params {
  u32 param2;
  u32 param1;
  u32 param0;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">param2</span></code></dt>
<dd>third parameter</dd>
<dt><code class="docutils literal"><span class="pre">param1</span></code></dt>
<dd>second parameter</dd>
<dt><code class="docutils literal"><span class="pre">param0</span></code></dt>
<dd>first parameter</dd>
</dl>
<dl class="function">
<dt id="c.next_request">
struct <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> * <code class="descname">next_request</code><span class="sig-paren">(</span>struct list_head *<em>&nbsp;list</em><span class="sig-paren">)</span><a class="headerlink" href="#c.next_request" title="Permalink to this definition">¶</a></dt>
<dd><p>gets the next request on the given list</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">list_head</span> <span class="pre">*</span> <span class="pre">list</span></code></dt>
<dd>the request list to operate on</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function return <code class="docutils literal"><span class="pre">NULL</span></code> or the first
request available on <strong>list</strong>.</p>
<dl class="function">
<dt id="c.dwc3_gadget_move_started_request">
void <code class="descname">dwc3_gadget_move_started_request</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>&nbsp;req</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_move_started_request" title="Permalink to this definition">¶</a></dt>
<dd><p>move <strong>req</strong> to the started_list</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*</span> <span class="pre">req</span></code></dt>
<dd>the request to be moved</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will move <strong>req</strong> from its
current list to the endpoint&#8217;s started_list.</p>
<dl class="function">
<dt id="c.dwc3_gadget_ep_get_transfer_index">
void <code class="descname">dwc3_gadget_ep_get_transfer_index</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_ep_get_transfer_index" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets transfer index from HW</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>dwc3 endpoint</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. Returns the transfer resource
index for a given endpoint.</p>
<dl class="function">
<dt id="c.dwc3_gadget_set_test_mode">
int <code class="descname">dwc3_gadget_set_test_mode</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em>, int<em>&nbsp;mode</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_set_test_mode" title="Permalink to this definition">¶</a></dt>
<dd><p>enables usb2 test modes</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our context structure</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">mode</span></code></dt>
<dd>the mode to set (J, K SE0 NAK, Force Enable)</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will return 0 on
success or -EINVAL if wrong Test Selector is passed.</p>
<dl class="function">
<dt id="c.dwc3_gadget_get_link_state">
int <code class="descname">dwc3_gadget_get_link_state</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_get_link_state" title="Permalink to this definition">¶</a></dt>
<dd><p>gets current state of usb link</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our context structure</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will
return the link state on success (&gt;= 0) or -ETIMEDOUT.</p>
<dl class="function">
<dt id="c.dwc3_gadget_set_link_state">
int <code class="descname">dwc3_gadget_set_link_state</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em>, enum dwc3_link_state<em>&nbsp;state</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_set_link_state" title="Permalink to this definition">¶</a></dt>
<dd><p>sets usb link to a particular state</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our context structure</dd>
<dt><code class="docutils literal"><span class="pre">enum</span> <span class="pre">dwc3_link_state</span> <span class="pre">state</span></code></dt>
<dd>the state to put link into</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will
return 0 on success or -ETIMEDOUT.</p>
<dl class="function">
<dt id="c.dwc3_ep_inc_trb">
void <code class="descname">dwc3_ep_inc_trb</code><span class="sig-paren">(</span>u8 *<em>&nbsp;index</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_inc_trb" title="Permalink to this definition">¶</a></dt>
<dd><p>increment a trb index.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">u8</span> <span class="pre">*</span> <span class="pre">index</span></code></dt>
<dd>Pointer to the TRB index to increment.</dd>
</dl>
<p><strong>Description</strong></p>
<p>The index should never point to the link TRB. After incrementing,
if it is point to the link TRB, wrap around to the beginning. The
link TRB is always at the last TRB entry.</p>
<dl class="function">
<dt id="c.dwc3_ep_inc_enq">
void <code class="descname">dwc3_ep_inc_enq</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_inc_enq" title="Permalink to this definition">¶</a></dt>
<dd><p>increment endpoint&#8217;s enqueue pointer</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>The endpoint whose enqueue pointer we&#8217;re incrementing</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_ep_inc_deq">
void <code class="descname">dwc3_ep_inc_deq</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_inc_deq" title="Permalink to this definition">¶</a></dt>
<dd><p>increment endpoint&#8217;s dequeue pointer</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>The endpoint whose enqueue pointer we&#8217;re incrementing</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_gadget_giveback">
void <code class="descname">dwc3_gadget_giveback</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em>, struct <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>&nbsp;req</em>, int<em>&nbsp;status</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_giveback" title="Permalink to this definition">¶</a></dt>
<dd><p>call struct usb_request&#8217;s -&gt;complete callback</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>The endpoint to whom the request belongs to</dd>
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*</span> <span class="pre">req</span></code></dt>
<dd>The request we&#8217;re giving back</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">status</span></code></dt>
<dd>completion code for the request</dd>
</dl>
<p><strong>Description</strong></p>
<p>Must be called with controller&#8217;s lock held and interrupts disabled. This
function will unmap <strong>req</strong> and call its -&gt;:c:func:<cite>complete()</cite> callback to notify upper
layers that it has completed.</p>
<dl class="function">
<dt id="c.dwc3_send_gadget_generic_command">
int <code class="descname">dwc3_send_gadget_generic_command</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em>, unsigned<em>&nbsp;cmd</em>, u32<em>&nbsp;param</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_send_gadget_generic_command" title="Permalink to this definition">¶</a></dt>
<dd><p>issue a generic command for the controller</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to the controller context</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">cmd</span></code></dt>
<dd>the command to be issued</dd>
<dt><code class="docutils literal"><span class="pre">u32</span> <span class="pre">param</span></code></dt>
<dd>command parameter</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. Issue <strong>cmd</strong> with a given <strong>param</strong> to <strong>dwc</strong>
and wait for its completion.</p>
<dl class="function">
<dt id="c.dwc3_send_gadget_ep_cmd">
int <code class="descname">dwc3_send_gadget_ep_cmd</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em>, unsigned<em>&nbsp;cmd</em>, struct <a class="reference internal" href="#c.dwc3_gadget_ep_cmd_params" title="dwc3_gadget_ep_cmd_params">dwc3_gadget_ep_cmd_params</a> *<em>&nbsp;params</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_send_gadget_ep_cmd" title="Permalink to this definition">¶</a></dt>
<dd><p>issue an endpoint command</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>the endpoint to which the command is going to be issued</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">cmd</span></code></dt>
<dd>the command to be issued</dd>
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_gadget_ep_cmd_params</span> <span class="pre">*</span> <span class="pre">params</span></code></dt>
<dd>parameters to the command</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should handle locking. This function will issue <strong>cmd</strong> with given
<strong>params</strong> to <strong>dep</strong> and wait for its completion.</p>
<dl class="function">
<dt id="c.dwc3_gadget_start_config">
int <code class="descname">dwc3_gadget_start_config</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_start_config" title="Permalink to this definition">¶</a></dt>
<dd><p>configure ep resources</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>endpoint that is being enabled</dd>
</dl>
<p><strong>Description</strong></p>
<p>Issue a <code class="docutils literal"><span class="pre">DWC3_DEPCMD_DEPSTARTCFG</span></code> command to <strong>dep</strong>. After the command&#8217;s
completion, it will set Transfer Resource for all available endpoints.</p>
<p>The assignment of transfer resources cannot perfectly follow the data book
due to the fact that the controller driver does not have all knowledge of the
configuration in advance. It is given this information piecemeal by the
composite gadget framework after every SET_CONFIGURATION and
SET_INTERFACE. Trying to follow the databook programming model in this
scenario can cause errors. For two reasons:</p>
<p>1) The databook says to do <code class="docutils literal"><span class="pre">DWC3_DEPCMD_DEPSTARTCFG</span></code> for every
<code class="docutils literal"><span class="pre">USB_REQ_SET_CONFIGURATION</span></code> and <code class="docutils literal"><span class="pre">USB_REQ_SET_INTERFACE</span></code> (8.1.5). This is
incorrect in the scenario of multiple interfaces.</p>
<p>2) The databook does not mention doing more <code class="docutils literal"><span class="pre">DWC3_DEPCMD_DEPXFERCFG</span></code> for new
endpoint on alt setting (8.1.6).</p>
<p>The following simplified method is used instead:</p>
<p>All hardware endpoints can be assigned a transfer resource and this setting
will stay persistent until either a core reset or hibernation. So whenever we
do a <code class="docutils literal"><span class="pre">DWC3_DEPCMD_DEPSTARTCFG``(0)</span> <span class="pre">we</span> <span class="pre">can</span> <span class="pre">go</span> <span class="pre">ahead</span> <span class="pre">and</span> <span class="pre">do</span>
<span class="pre">``DWC3_DEPCMD_DEPXFERCFG</span></code> for every hardware endpoint as well. We are
guaranteed that there are as many transfer resources as endpoints.</p>
<p>This function is called for each endpoint when it is being enabled but is
triggered only when called for EP0-out, which always happens first, and which
should only happen in one of the above conditions.</p>
<dl class="function">
<dt id="c.__dwc3_gadget_ep_enable">
int <code class="descname">__dwc3_gadget_ep_enable</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em>, unsigned int<em>&nbsp;action</em><span class="sig-paren">)</span><a class="headerlink" href="#c.__dwc3_gadget_ep_enable" title="Permalink to this definition">¶</a></dt>
<dd><p>initializes a hw endpoint</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>endpoint to be initialized</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">action</span></code></dt>
<dd>one of INIT, MODIFY or RESTORE</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. Execute all necessary commands to
initialize a HW endpoint so it can be used by a gadget driver.</p>
<dl class="function">
<dt id="c.__dwc3_gadget_ep_disable">
int <code class="descname">__dwc3_gadget_ep_disable</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.__dwc3_gadget_ep_disable" title="Permalink to this definition">¶</a></dt>
<dd><p>disables a hw endpoint</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>the endpoint to disable</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function undoes what __dwc3_gadget_ep_enable did and also removes
requests which are currently being processed by the hardware and those which
are not yet scheduled.</p>
<p>Caller should take care of locking.</p>
<dl class="function">
<dt id="c.dwc3_ep_prev_trb">
struct <a class="reference internal" href="#c.dwc3_trb" title="dwc3_trb">dwc3_trb</a> * <code class="descname">dwc3_ep_prev_trb</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em>, u8<em>&nbsp;index</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_prev_trb" title="Permalink to this definition">¶</a></dt>
<dd><p>returns the previous TRB in the ring</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>The endpoint with the TRB ring</dd>
<dt><code class="docutils literal"><span class="pre">u8</span> <span class="pre">index</span></code></dt>
<dd>The index of the current TRB in the ring</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns the TRB prior to the one pointed to by the index. If the
index is 0, we will wrap backwards, skip the link TRB, and return
the one just before that.</p>
<dl class="function">
<dt id="c.dwc3_prepare_one_trb">
void <code class="descname">dwc3_prepare_one_trb</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>&nbsp;dep</em>, struct <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>&nbsp;req</em>, unsigned<em>&nbsp;chain</em>, unsigned<em>&nbsp;node</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_prepare_one_trb" title="Permalink to this definition">¶</a></dt>
<dd><p>setup one TRB from one request</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*</span> <span class="pre">dep</span></code></dt>
<dd>endpoint for which this request is prepared</dd>
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*</span> <span class="pre">req</span></code></dt>
<dd>dwc3_request pointer</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">chain</span></code></dt>
<dd>should this TRB be chained to the next?</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">node</span></code></dt>
<dd>only for isochronous endpoints. First TRB needs different type.</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_gadget_setup_nump">
void <code class="descname">dwc3_gadget_setup_nump</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_setup_nump" title="Permalink to this definition">¶</a></dt>
<dd><p>calculate and initialize NUMP field of <code class="docutils literal"><span class="pre">DWC3_DCFG</span></code></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our context structure</dd>
</dl>
<p><strong>Description</strong></p>
<p>The following looks like complex but it&#8217;s actually very simple. In order to
calculate the number of packets we can burst at once on OUT transfers, we&#8217;re
gonna use RxFIFO size.</p>
<p>To calculate RxFIFO size we need two numbers:
MDWIDTH = size, in bits, of the internal memory bus
RAM2_DEPTH = depth, in MDWIDTH, of internal RAM2 (where RxFIFO sits)</p>
<p>Given these two numbers, the formula is simple:</p>
<p>RxFIFO Size = (RAM2_DEPTH * MDWIDTH / 8) - 24 - 16;</p>
<p>24 bytes is for 3x SETUP packets
16 bytes is a clock domain crossing tolerance</p>
<p>Given RxFIFO Size, NUMP = RxFIFOSize / 1024;</p>
<dl class="function">
<dt id="c.dwc3_gadget_init">
int <code class="descname">dwc3_gadget_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_init" title="Permalink to this definition">¶</a></dt>
<dd><p>initializes gadget related registers</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our controller context structure</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno.</p>
<dl class="function">
<dt id="c.DWC3_DEFAULT_AUTOSUSPEND_DELAY">
<code class="descname">DWC3_DEFAULT_AUTOSUSPEND_DELAY</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#c.DWC3_DEFAULT_AUTOSUSPEND_DELAY" title="Permalink to this definition">¶</a></dt>
<dd><p>DesignWare USB3 DRD Controller Core file</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<p><strong>Description</strong></p>
<p>Copyright (C) 2010-2011 Texas Instruments Incorporated - <a class="reference external" href="http://www.ti.com">http://www.ti.com</a></p>
<dl class="docutils">
<dt>Authors: Felipe Balbi &lt;balbi**ti.com**&gt;,</dt>
<dd>Sebastian Andrzej Siewior &lt;bigeasy**linutronix.de**&gt;</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_get_dr_mode">
int <code class="descname">dwc3_get_dr_mode</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_get_dr_mode" title="Permalink to this definition">¶</a></dt>
<dd><p>Validates and sets dr_mode</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our context structure</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_core_soft_reset">
int <code class="descname">dwc3_core_soft_reset</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_core_soft_reset" title="Permalink to this definition">¶</a></dt>
<dd><p>Issues core soft reset and PHY reset</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our context structure</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_free_one_event_buffer">
void <code class="descname">dwc3_free_one_event_buffer</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em>, struct <a class="reference internal" href="#c.dwc3_event_buffer" title="dwc3_event_buffer">dwc3_event_buffer</a> *<em>&nbsp;evt</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_free_one_event_buffer" title="Permalink to this definition">¶</a></dt>
<dd><p>Frees one event buffer</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>Pointer to our controller context structure</dd>
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3_event_buffer</span> <span class="pre">*</span> <span class="pre">evt</span></code></dt>
<dd>Pointer to event buffer to be freed</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_alloc_one_event_buffer">
struct <a class="reference internal" href="#c.dwc3_event_buffer" title="dwc3_event_buffer">dwc3_event_buffer</a> * <code class="descname">dwc3_alloc_one_event_buffer</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em>, unsigned<em>&nbsp;length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_alloc_one_event_buffer" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocates one event buffer structure</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>Pointer to our controller context structure</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">length</span></code></dt>
<dd>size of the event buffer</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns a pointer to the allocated event buffer structure on success
otherwise ERR_PTR(errno).</p>
<dl class="function">
<dt id="c.dwc3_free_event_buffers">
void <code class="descname">dwc3_free_event_buffers</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_free_event_buffers" title="Permalink to this definition">¶</a></dt>
<dd><p>frees all allocated event buffers</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>Pointer to our controller context structure</dd>
</dl>
<dl class="function">
<dt id="c.dwc3_alloc_event_buffers">
int <code class="descname">dwc3_alloc_event_buffers</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em>, unsigned<em>&nbsp;length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_alloc_event_buffers" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocates <strong>num</strong> event buffers of size <strong>length</strong></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our controller context structure</dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">length</span></code></dt>
<dd>size of event buffer</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno. In the error case, dwc
may contain some buffers allocated but not all which were requested.</p>
<dl class="function">
<dt id="c.dwc3_event_buffers_setup">
int <code class="descname">dwc3_event_buffers_setup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_event_buffers_setup" title="Permalink to this definition">¶</a></dt>
<dd><p>setup our allocated event buffers</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>pointer to our controller context structure</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno.</p>
<dl class="function">
<dt id="c.dwc3_phy_setup">
int <code class="descname">dwc3_phy_setup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_phy_setup" title="Permalink to this definition">¶</a></dt>
<dd><p>Configure USB PHY Interface of DWC3 Core</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>Pointer to our controller context structure</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success. The USB PHY interfaces are configured but not
initialized. The PHY interfaces and the PHYs get initialized together with
the core in dwc3_core_init.</p>
<dl class="function">
<dt id="c.dwc3_core_init">
int <code class="descname">dwc3_core_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>&nbsp;dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_core_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Low-level initialization of DWC3 Core</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*</span> <span class="pre">dwc</span></code></dt>
<dd>Pointer to our controller context structure</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno.</p>
<table class="docutils footnote" frame="void" id="trb" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id4">2</a>, <a class="fn-backref" href="#id6">3</a>)</em> Transfer Request Block</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="link-trb" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[2]</a></td><td>Transfer Request Block pointing to another Transfer
Request Block.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id8">2</a>)</em> The Debug File System</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="configfs" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[4]</a></td><td>The Config File System</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="cbw" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>Command Block Wrapper</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="writing_musb_glue_layer.html" class="btn btn-neutral float-right" title="Writing a MUSB Glue Layer" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="writing_usb_driver.html" class="btn btn-neutral" title="Writing USB Device Drivers" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>